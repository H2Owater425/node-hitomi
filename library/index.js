"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,a){void 0===a&&(a=n),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,a){void 0===a&&(a=n),e[a]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0});const https_1=require("https"),tls_1=require("tls"),syncrequest=__importStar(require("sync-request"));var hitomi;!function(e){const t=syncrequest.default("GET","https://ltn.hitomi.la/gg.js",{headers:{referer:"https://hitomi.la"}}).getBody("utf8").split("b: '")[1].split("'")[0],n=function(){const e=syncrequest.default("GET","https://ltn.hitomi.la/gg.js",{headers:{referer:"https://hitomi.la"}}).getBody("utf8");let t="";return e.match(/case [0-9]+:/g).sort().forEach((e=>{const n=e.split("case ")[1].split(":")[0];t+=""==t?n:"|"+n})),new RegExp(t,"g")}(),a=["artist","group","parody","character"];class s extends Error{constructor(e,t){super("Unknown"),this.code=e;const n=t.includes("'")?"`":"'";switch(t=n+t+n,e){case"INVALID_VALUE":this.message="Value of "+t+" was not valid";break;case"DUPLICATED_ELEMENT":this.message="Element of "+t+" was duplicated";break;case"LACK_OF_ELEMENT":this.message="Elements of "+t+" was not enough";break;case"REQEUST_REJECTED":this.message="Request to "+t+" was rejected"}}get name(){return"HitomiError ["+this.code+"]"}}function i(e){return Number.parseInt(e)===Number(e)&&Number.isFinite(e)&&"object"!=typeof e}function r(e,t={}){const n=t.splitBy||4;let a=new ArrayBuffer(e.byteLength),s=new Uint8Array(a);for(let t=0;t<e.byteLength;++t)s[t]=e[t];const i=new DataView(a),r=i.byteLength/n;let l=new Set;for(let e=0;e<r;e++)l.add(i.getInt32(e*n,!1));return l}const l=new class extends https_1.Agent{createConnection(e,t){return(0,tls_1.connect)(Object.assign(e,{servername:void 0}),t)}};function o(e,t={}){return new Promise((function(n,a){const i=new URL(e);(0,https_1.request)({hostname:i.hostname,path:i.pathname,method:"GET",port:443,headers:Object.assign(t,{Accept:"*/*",Connection:"keep-alive",Referer:"https://hitomi.la"}),agent:l},(function(t){let i=[],r=0;switch(t.statusCode){case 200:case 206:t.on("data",(function(e){i.push(e),r+=e.byteLength})).on("error",(function(){a(new s("REQEUST_REJECTED",e))})).on("end",(function(){n(Buffer.concat(i,r))}));break;default:a(new s("REQEUST_REJECTED",e))}})).on("error",(function(){a(new s("REQEUST_REJECTED",e))})).end()}))}function c(e,t={}){if("language"!==e.type||void 0===t.orderBy){let n="",a="",s="all";switch(e.type){case"male":case"female":n="tag/",a=e.type+":"+e.name.replace(/_/g," ");break;case"language":a=t.orderBy||"index",s=e.name;break;default:n=e.type+"/",a=e.name.replace(/_/g," ")}return"https://ltn.hitomi.la/n/"+n+a+"-"+s+".nozomi"}throw new s("INVALID_VALUE","options['orderBy']")}function u(e,t={}){if("language"!==e||void 0===t.startWith){let n="https://hitomi.la/";switch(e){case"tag":case"male":case"female":n+="alltags-";break;case"artist":n+="allartists-";break;case"series":n+="allseries-";break;case"character":n+="allcharacters-";break;case"group":n+="allgroups-";break;case"language":n="ltn."+n+"language_support.js";break;default:throw new s("INVALID_VALUE","extension")}if("language"!==e){switch(e){case"male":n+="m";break;case"female":n+="f";break;default:"0-9"===t.startWith?n+="123":n+=t.startWith}return n+".html"}return n}throw new s("INVALID_VALUE","options['startWith']")}e.getNozomiUrl=c,e.getTagUrl=u,e.getImageUrl=function(e,a,r={}){const l=r.isThumbnail||!1,o=r.isSmall||!1;if(!o||l&&"avif"===a){switch(a){case"jpg":case"png":case"gif":if(!l&&e.extension===a)break;case"webp":case"avif":if(e["has"+a.charAt(0).toUpperCase()+a.slice(1)])break;default:throw new s("INVALID_VALUE","extension")}if(/^[0-9a-f]{64}$/.test(e.hash)){if(i(e.index)&&e.index>=0){const s=String(Number.parseInt(e.hash.slice(-1)+e.hash.slice(-3,-1),16));let i=n.test(s)?"a":"b",r="",c="";return l?(r=e.hash.slice(-1)+"/"+e.hash.slice(-3,-1)+"/"+e.hash,i+="tn",c=a+(o&&"avif"===a?"small":"")+"bigtn"):(r=t+"/"+s+"/"+e.hash,"jpg"===a||"png"===a?(i+="b",c="images"):(i+="a",c=a)),"https://"+i+".hitomi.la/"+c+"/"+r+"."+a}throw new s("INVALID_VALUE","image['index']")}throw new s("INVALID_VALUE","image['hash']")}throw new s("INVALID_VALUE","extension")},e.getVideoUrl=function(e){if("anime"===e.type)return"https://streaming.hitomi.la/videos/"+e.title.display.toLowerCase().replace(/\s/g,"-")+".mp4";throw new s("INVALID_VALUE","gallery['type']")},e.getGalleryUrl=function(e){return("https://hitomi.la/"+("artistcg"!==e.type?e.type:"cg")+"/"+encodeURIComponent(Buffer.from(e.title.japanese||e.title.display).slice(0,200).toString("utf-8")).replace(/\(|\)|'|%(2[0235F]|3[CEF]|5[BD]|7[BD])/g,"-")+(null!==e.languageName.local?"-"+encodeURIComponent(e.languageName.local):"")+"-"+e.id+".html").toLocaleLowerCase()},e.getSecondThumbnailIndex=function(e){return Math.ceil((e.files.length-1)/2)},e.getGallery=function(e,t={}){if(i(e)&&e>0)return new Promise((function(n,s){o("https://ltn.hitomi.la/galleries/"+e+".js").then((function(s){var i,r;const l=JSON.parse(s.toString("utf8").slice(18));let o=JSON.parse('{ "id": '+e+', "title": { "display": "'+l.title.replace(/\"/g,'\\"')+'", "japanese": '+(null!==l.japanese_title?'"'+l.japanese_title.replace(/\"/g,'\\"')+'"':"null")+' }, "type": "'+l.type+'", "languageName": { "english": '+(null!==l.language?'"'+l.language+'"':"null")+', "local": '+(null!==l.language_localname?'"'+l.language_localname+'"':"null")+' }, "artists": [], "groups": [], "series": [], "characters": [], "tags": [], "files": [], "publishedDate": null, "translations": [], "relatedIds": [] }');for(let e=0;e<a.length;e++){const t=a[e]+"s";if(null!==l[t])for(let n=0;n<l[t].length;n++)o["parodys"!==t?t:"series"].push(l[t][n][a[e]])}if(null!==l.tags)for(let e=0;e<l.tags.length;e++){let t="tag";Boolean(l.tags[e].male)?t="male":Boolean(l.tags[e].female)&&(t="female"),o.tags.push({type:t,name:l.tags[e].tag})}if(null===(i=t.includeFiles)||void 0===i||i)for(let e=0;e<l.files.length;e++)o.files.push({index:e,hash:l.files[e].hash,extension:l.files[e].name.split(".").pop(),hasAvif:Boolean(l.files[e].hasavif),hasWebp:Boolean(l.files[e].haswebp),width:l.files[e].width,height:l.files[e].height});if(o.publishedDate=new Date(l.date),null!==(r=t.includeRelatedIds)&&void 0!==r&&r){for(let e=0;e<l.languages.length;e++)o.translations.push({id:Number(l.languages[e].galleryid),languageName:{english:l.languages[e].name,local:l.languages[e].language_localname}});o.relatedIds=l.related}n(o)})).catch(s)}));throw new s("INVALID_VALUE","id")},e.getIds=function e(t={}){return new Promise((function(n,a){var l,u,g,h,d,f,p;const[m,w]=[i(null===(l=t.range)||void 0===l?void 0:l.startIndex),i(null===(u=t.range)||void 0===u?void 0:u.endIndex)];!m||(null===(g=t.range)||void 0===g?void 0:g.startIndex)>=0?!w||(null===(h=t.range)||void 0===h?void 0:h.endIndex)>=(null===(d=t.range)||void 0===d?void 0:d.startIndex)?Array.isArray(t.tags)&&0!==t.tags.length?void 0===t.orderBy||"index"===t.orderBy?t.tags.reduce((function(e,t){return e.then((function(e){return new Promise((function(n,a){o(c(t)).then((function(a){const s=t.isNegative||!1,i=r(a);e.forEach((function(t){s===i.has(t)&&e.delete(t)})),n(e)})).catch(a)}))}))}),t.tags[0].isNegative?new Promise((function(t,n){e().then((function(e){t(new Set(e))})).catch(n)})):new Promise((function(e,n){o(c(t.tags.shift())).then((function(t){e(r(t))})).catch(n)}))).then((function(e){var a,s;let i=Array.from(e).slice(null===(a=t.range)||void 0===a?void 0:a.startIndex,null===(s=t.range)||void 0===s?void 0:s.endIndex);t.reverseResult?n(i):n(i.reverse())})).catch(a):a(new s("INVALID_VALUE","options['orderBy']")):o("https://ltn.hitomi.la/"+(t.orderBy||"index")+"-all.nozomi",{Range:"bytes="+(m?4*(null===(f=t.range)||void 0===f?void 0:f.startIndex):"0")+"-"+(w?4*(null===(p=t.range)||void 0===p?void 0:p.endIndex)+3:"")}).then((function(e){let a=Array.from(r(e));t.reverseResult?n(a):n(a.reverse())})).catch(a):a(new s("INVALID_VALUE","options['range']['endIndex']")):a(new s("INVALID_VALUE","options['range']['startIndex']"))}))},e.getParsedTags=function(e){const t=e.split(" ");if(0!==t.length){let e=[],n=new Set;for(let a=0;a<t.length;a++){const i=t[a].replace(/^-/,"").split(":");if(2!==i.length||!/^(artist|group|type|language|series|tag|male|female)$/.test(i[0])||!/^[^-_\.][a-z0-9-_.]+$/.test(i[1]))throw new s("INVALID_VALUE","splitTagStrings["+a+"]");{const r=i[0]+":"+i[1];if(n.has(r))throw new s("DUPLICATED_ELEMENT","splitTagStrings["+a+"]");e.push({type:i[0],name:i[1],isNegative:t[a].startsWith("-")}),n.add(r)}}return e}throw new s("LACK_OF_ELEMENT","splitTagStrings")},e.getTags=function(e,t={}){return new Promise((function(n,a){(void 0===t.startWith?"language"===e||"type"===e:"language"!==e&&"type"!==e)?"type"!==e?o(u(e,{startWith:t.startWith})).then((function(t){const a=t.toString("utf8").match(RegExp("language"===e?'(?<=")(?!all)[a-z]+(?=":)':"(?<=/tag/"+("male"===e||"female"===e?e+"%3A":"")+")[a-z0-9%]+(?=-all\\.html)","g"))||[];let s=[];for(let t=0;t<a.length;t++)s.push({type:e,name:decodeURIComponent(a[t])});n(s)})).catch(a):n([{type:"type",name:"doujinshi"},{type:"type",name:"manga"},{type:"type",name:"artistcg"},{type:"type",name:"gamecg"},{type:"type",name:"anime"}]):a(new s("INVALID_VALUE","options['startWith']"))}))}}(hitomi||(hitomi={})),exports.default=hitomi;