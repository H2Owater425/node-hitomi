"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const https_1=require("https"),tls_1=require("tls");var hitomi;!function(e){class t extends Error{constructor(e,...t){super(function(e,...t){switch(e){case"INVALID_VALUE":return`Value of '${t[0]}' was not valid`;case"DUPLICATED_ELEMENT":return`Element of '${t[0]}' was duplicated`;case"LACK_OF_ELEMENT":return`Elements of '${t[0]}' was not enough`;case"REQEUST_REJECTED":return`Request to '${t[0]}' rejected request'`}}(e,t)),this.code=e}get name(){return`HitomiError [${this.code}]`}}function n(e){return!(Number.parseInt(e)!==Number(e)||!Number.isFinite(e)||"object"==typeof e)}function i(e){let t=new ArrayBuffer(e.byteLength),n=new Uint8Array(t);for(let t=0;t<e.byteLength;++t)n[t]=e[t];return t}const a=new class extends https_1.Agent{createConnection(e,t){return e.servername=void 0,tls_1.connect(e,t)}}({rejectUnauthorized:!1,keepAlive:!0});function s(e,n){return new Promise(function(i,s){const o=new URL(e);https_1.request({hostname:o.hostname,path:o.pathname,method:"GET",port:443,headers:Object.assign({Accept:"*/*",Connection:"keep-alive"},n),agent:a},function(e){let n=[],a=0;e.on("data",function(e){n.push(e),a+=e.byteLength}),e.on("error",function(e){s(new t("REQEUST_REJECTED",o))}),e.on("end",function(){i(Buffer.concat(n,a))})}).on("error",function(e){s(new t("REQEUST_REJECTED",o))}).end()})}function o(e){return`https://hitomi.la/${e.type}/${encodeURIComponent(null!==e.title.japanese?e.title.japanese:e.title.display).replace(/\(|\)|'|%(2(0|2|3|5|F)|3(C|E|F)|5(B|D)|7(B|D))/g,"-")}${null!==e.languageName.local?`-${encodeURIComponent(e.languageName.local)}`:""}-${e.id}.html`.toLocaleLowerCase()}function r(e,n){if("language"!==e.type&&void 0!==n&&(n.orderBy,1))throw new t("INVALID_VALUE","option['orderBy']");{const t=void 0!==n&&void 0!==n.orderBy?n.orderBy:"index";let i="",a="",s="all";switch(e.type){case"male":case"female":i="tag/",a=`${e.type}:${e.name.replace(/_/g," ")}`;break;case"language":a=t,s=e.name;break;default:i=`${e.type}/`,a=e.name.replace(/_/g," ")}return`https://ltn.hitomi.la/n/${i}${a}-${s}.nozomi`}}function l(e,t){const n=t.startWith;let i="";switch(e){case"tag":case"male":case"female":i="https://hitomi.la/alltags-";break;case"artist":i="https://hitomi.la/allartists-";break;case"series":i="https://hitomi.la/allseries-";break;case"character":i="https://hitomi.la/allcharacters-";break;case"group":i="https://hitomi.la/allgroups-";break;case"language":i="https://ltn.hitomi.la/language_support.js"}return"language"===e?i:"male"===e?`${i}m.html`:"female"===e?`${i}f.html`:`${i}${"0-9"!==n?n:"123"}.html`}function c(e,a){return new Promise(function(o,r){if(!n(e.startIndex)||n(e.startIndex)&&e.startIndex<0)r(new t("INVALID_VALUE","range['startIndex']"));else if(void 0===e.endIndex||n(e.endIndex)&&!(n(e.endIndex)&&e.endIndex<=e.startIndex)){const t=4*e.startIndex,n=void 0!==e.endIndex?t+4*(e.endIndex+1)-1:"",l=void 0!==a&&void 0!==a.orderBy?a.orderBy:"index",c=void 0!==a&&void 0!==a.reverseResult&&a.reverseResult;s(`https://ltn.hitomi.la/${l}-all.nozomi`,{Range:`bytes=${t}-${n}`}).then(function(e){const t=i(e),n=new DataView(t),a=n.byteLength/4;let s=[];if(c)for(let e=0;e<a;e++)s.push(n.getInt32(4*e,!1));else for(let e=a-1;-1!==e;e--)s.push(n.getInt32(4*e,!1));o(s)}).catch(r)}else r(new t("INVALID_VALUE","range['endIndex']"))})}e.getImageUrl=function(e,i,a){const s=void 0!==a&&void 0!==a.isThumbnail&&a.isThumbnail;switch(i){case"jpg":if(s||"jpg"===e.extension)break;throw new t("INVALID_VALUE","extension");case"png":if("png"!==e.extension)throw new t("INVALID_VALUE","extension");if(s)throw new t("INVALID_VALUE","extension");break;case"avif":if(e.hasAvif)break;throw new t("INVALID_VALUE","extension");case"webp":if(e.hasWebp){if(s)throw new t("INVALID_VALUE","extension");break}throw new t("INVALID_VALUE","extension");case"gif":if("gif"!==e.extension)throw new t("INVALID_VALUE","extension");if(s)throw new t("INVALID_VALUE","extension")}if(/^[0-9a-f]{64}$/.test(e.hash)){if(!n(e.index)||e.index<0)throw new t("INVALID_VALUE","image['index']");if(s&&0!==e.index)throw new t("INVALID_VALUE","image['index']");{const t=`${e.hash.slice(-1)}/${e.hash.slice(-3,-1)}/${e.hash}`;let n="",a="";if(s)n="tn",a="jpg"===i||"png"===i?"bigtn":"avifbigtn";else{let t=Number.parseInt(e.hash.slice(-3,-1),16),s=0;t<64?s=2:t<128&&(s=1),n=`${String.fromCharCode(s+97)}`,"jpg"===i||"png"===i?(n+="b",a="images"):(n+="a",a=`${i}`)}return`https://${n}.hitomi.la/${a}/${t}.${i}`}}throw new t("INVALID_VALUE","image['hash']")},e.getVideoUrl=function(e){return`https://streaming.hitomi.la/videos/${e.title.display.toLowerCase().replace(/\s/g,"-")}.mp4`},e.getGalleryUrl=o,e.getNozomiUrl=r,e.getTagUrl=l,e.getGallery=function(e,i){if(!n(e)||n(e)&&e<1)throw new t("INVALID_VALUE","id");{const t=void 0===i||void 0===i.includeFiles||i.includeFiles,n=void 0===i||void 0===i.includeFullData||i.includeFullData;return new Promise(function(i,a){s(`https://ltn.hitomi.la/galleries/${e}.js`).then(function(e){const r=JSON.parse(e.toString("utf8").slice(18));let l={id:r.id,title:{display:r.title,japanese:r.japanese_title},type:r.type,languageName:{english:r.language,local:r.language_localname},artistList:[],groupList:[],seriesList:[],characterList:[],tagList:[],fileList:[],publishedDate:new Date(`${r.date}:00`.replace(" ","T"))};if(null!==r.tags)for(let e=0;e<r.tags.length;e++){let t="tag";Boolean(r.tags[e].male)?t="male":Boolean(r.tags[e].female)&&(t="female"),l.tagList.push({type:t,name:r.tags[e].tag})}if(t)for(let e=0;e<r.files.length;e++)l.fileList.push({index:e,hash:r.files[e].hash,extension:r.files[e].name.split(".").pop(),hasAvif:Boolean(r.files[e].hasavif),hasWebp:Boolean(r.files[e].haswebp),width:r.files[e].width,height:r.files[e].height});n?s(o(l)).then(function(e){const t=e.toString("utf8").split('content">')[1];void 0!==t&&["artist","group","series","character"].forEach(function(e,n,i){var a;null===(a=t.match(RegExp(`(?<=/${e}/)[a-z0-9%]+(?=-all\\.html)`,"g")))||void 0===a||a.forEach(function(t,n,i){l[`${e}List`].push(decodeURIComponent(t))})}),i(l)}).catch(a):i(l)}).catch(a)})}},e.getIdList=c,e.getParsedTagList=function(e){const n=e.split(" ");if(n.length<1)throw new t("LACK_OF_ELEMENT","splittedTagStringList");{let e=[],i=[];for(let a=0;a<n.length;a++){const s=n[a].replace(/^-/,"").split(":");if(2!==s.length||void 0===s[0]||void 0===s[1]||""===s[0]||""===s[1]||!/^(artist|group|type|language|series|tag|male|female)$/.test(s[0])||!/^[^-_\.][a-z0-9-_.]+$/.test(s[1]))throw new t("INVALID_VALUE",`splittedTagStringList[${a}]`);{const o=`${s[0]}:${s[1]}`;if(i.includes(o))throw new t("DUPLICATED_ELEMENT","tagList");e.push({type:s[0],name:s[1],isNegative:n[a].startsWith("-")}),i.push(o)}}return e}},e.getQueriedIdList=function(e){return new Promise(function(n,a){if(e.length<1)throw new t("LACK_OF_ELEMENT","tagList");{e.sort(function(e,t){const[n,i]=[void 0!==e.isNegative&&e.isNegative,void 0!==t.isNegative&&t.isNegative];return n||i?n?1:-1:0});let t=new Set,o=e.map(function(e,t,n){return new Promise(function(t,n){s(r(e)).then(function(e){const n=i(e),a=new DataView(n),s=a.byteLength/4;let o=new Set;for(let e=0;e<s;e++)o.add(a.getInt32(4*e,!1));t(o)}).catch(n)})});return o.push(new Promise(function(e,t){e(new Set)})),void 0!==e[0].isNegative&&e[0].isNegative&&(e.unshift({type:"female",name:"yandere"}),o.unshift(new Promise(function(e,t){c({startIndex:0}).then(function(t){e(new Set(t))}).catch(t)}))),void o.reduce(function(n,i,a,s){return n.then(function(n){const s=a-1;if(0===s)t=n;else{const i=void 0!==e[s].isNegative&&e[s].isNegative;t.forEach(function(e,a,s){i===n.has(e)&&t.delete(e)})}return i})}).then(function(e){n(Array.from(t))}).catch(a)}})},e.getTagList=function(e,n){return new Promise(function(i,a){if(("language"===e||"type"===e||void 0!==n&&void 0!==n.startWith)&&("language"!==e&&"type"!==e||void 0===n||void 0===n.startWith))if("type"===e)i([{type:"type",name:"doujinshi"},{type:"type",name:"manga"},{type:"type",name:"artistcg"},{type:"type",name:"gamecg"},{type:"type",name:"anime"}]);else{const t=n.startWith;s(l(e,{startWith:t})).then(function(n){let a="";a="language"===e?'(?<=")(?!all)[a-z]+(?=":)':`(?<=/tag/${"male"===e||"female"===e?e+"%3A":""})[a-z0-9%]+(?=-all\\.html)`;const s=n.toString("utf8").match(RegExp(a,"g"))||[],o=RegExp(`^(?=[${t}])[a-z0-9%]+$`);let r=[];for(let t=0;t<s.length;t++){const n=decodeURIComponent(s[t]);null!==s[t].match(o)&&r.push({type:e,name:n})}i(r)}).catch(a)}else a(new t("INVALID_VALUE","startingCharacter"))})}}(hitomi||(hitomi={})),exports.default=hitomi;