"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const https_1=require("https"),tls_1=require("tls");var hitomi;!function(e){function t(e){return!(Number.parseInt(e)!==Number(e)||!Number.isFinite(e)||"object"==typeof e)}function n(e){let t=new ArrayBuffer(e.byteLength),n=new Uint8Array(t);for(let t=0;t<e.byteLength;++t)n[t]=e[t];return t}const i=new class extends https_1.Agent{createConnection(e,t){return e.servername=void 0,tls_1.connect(e,t)}}({rejectUnauthorized:!1,keepAlive:!0});function a(e,t){return new Promise(function(n,a){const r=new URL(e);https_1.request({hostname:r.hostname,path:r.pathname,method:"GET",port:443,headers:Object.assign({Accept:"*/*",Connection:"keep-alive"},t),agent:i},function(e){let t=[],i=0;e.on("data",function(e){t.push(e),i+=e.byteLength}),e.on("error",function(e){a(e)}),e.on("end",function(){n(Buffer.concat(t,i))})}).on("error",a).end()})}function r(e){return`https://hitomi.la/${e.type}/${encodeURIComponent(null!==e.title.japanese?e.title.japanese:e.title.display).replace(/\(|\)|'|%(2(0|2|3|5|F)|3(C|E|F)|5(B|D)|7(B|D))/g,"-")}${null!==e.languageName.local?`-${encodeURIComponent(e.languageName.local)}`:""}-${e.id}.html`.toLocaleLowerCase()}function o(e,t){if("language"!==e.type&&void 0!==t&&(t.orderBy,1))throw new Error(`Invalid order criteria for ${e.type} tag type`);{const n=void 0!==t&&void 0!==t.orderBy?t.orderBy:"index";let i="",a="",r="all";switch(e.type){case"male":case"female":i="tag/",a=`${e.type}:${e.name.replace(/_/g," ")}`;break;case"language":a=n,r=e.name;break;default:i=`${e.type}/`,a=e.name.replace(/_/g," ")}return`https://ltn.hitomi.la/n/${i}${a}-${r}.nozomi`}}function s(e,t){const n=t.startWith;let i="";switch(e){case"tag":case"male":case"female":i="https://hitomi.la/alltags-";break;case"artist":i="https://hitomi.la/allartists-";break;case"series":i="https://hitomi.la/allseries-";break;case"character":i="https://hitomi.la/allcharacters-";break;case"group":i="https://hitomi.la/allgroups-";break;case"language":i="https://ltn.hitomi.la/language_support.js"}return"language"===e?i:"male"===e?`${i}m.html`:"female"===e?`${i}f.html`:`${i}${"0-9"!==n?n:"123"}.html`}function l(e,i){return new Promise(function(r,o){if(!t(e.startIndex)||t(e.startIndex)&&e.startIndex<0)o(new Error("Invalid startIndex value"));else if(void 0===e.endIndex||t(e.endIndex)&&!(t(e.endIndex)&&e.endIndex<=e.startIndex)){const t=4*e.startIndex,s=void 0!==e.endIndex?t+4*(e.endIndex+1)-1:"",l=void 0!==i&&void 0!==i.orderBy?i.orderBy:"index",h=void 0!==i&&void 0!==i.reverseResult&&i.reverseResult;a(`https://ltn.hitomi.la/${l}-all.nozomi`,{Range:`bytes=${t}-${s}`}).then(function(e){const t=n(e),i=new DataView(t),a=i.byteLength/4;let o=[];if(h)for(let e=0;e<a;e++)o.push(i.getInt32(4*e,!1));else for(let e=a-1;-1!==e;e--)o.push(i.getInt32(4*e,!1));r(o)}).catch(o)}else o(new Error("Invalid endIndex value"))})}e.getImageUrl=function(e,n,i){const a=void 0!==i&&void 0!==i.isThumbnail&&i.isThumbnail;switch(n){case"jpg":if(a||"jpg"===e.extension)break;throw new Error("Invalid extension");case"png":if("png"!==e.extension)throw new Error("Invalid extension");if(a)throw new Error("Invalid extension for thumbnail");break;case"avif":if(e.hasAvif)break;throw new Error("Invalid extension");case"webp":if(e.hasWebp){if(a)throw new Error("Invalid extension for thumbnail");break}throw new Error("Invalid extension");case"gif":if("gif"!==e.extension)throw new Error("Invalid extension");if(a)throw new Error("Invalid extension for thumbnail")}if(/^[0-9a-f]{64}$/.test(e.hash)){if(!t(e.index)||e.index<0)throw new Error("Invalid image index");if(a&&0!==e.index)throw new Error("Invalid index for thumbnail");{const t=`${e.hash.slice(-1)}/${e.hash.slice(-3,-1)}/${e.hash}`;let i="",r="";if(a)i="tn",r="jpg"===n||"png"===n?"bigtn":"avifbigtn";else{let t=Number.parseInt(e.hash.slice(-3,-1),16),a=0;t<64?a=2:t<128&&(a=1),i=`${String.fromCharCode(a+97)}`,"jpg"===n||"png"===n?(i+="b",r="images"):(i+="a",r=`${n}`)}return`https://${i}.hitomi.la/${r}/${t}.${n}`}}throw new Error("Invalid hash value")},e.getVideoUrl=function(e){return`https://streaming.hitomi.la/videos/${e.title.display.toLowerCase().replace(/\s/g,"-")}.mp4`},e.getGalleryUrl=r,e.getNozomiUrl=o,e.getTagUrl=s,e.getGallery=function(e,n){if(!t(e)||t(e)&&e<1)throw new Error("Invalid id value");{const t=void 0===n||void 0===n.includeFiles||n.includeFiles,i=void 0===n||void 0===n.includeFullData||n.includeFullData;return new Promise(function(n,o){a(`https://ltn.hitomi.la/galleries/${e}.js`).then(function(e){const s=JSON.parse(e.toString("utf8").slice(18));let l={id:s.id,title:{display:s.title,japanese:s.japanese_title},type:s.type,languageName:{english:s.language,local:s.language_localname},artistList:[],groupList:[],seriesList:[],characterList:[],tagList:[],fileList:[],publishedDate:new Date(`${s.date}:00`.replace(" ","T"))};if(null!==s.tags)for(let e=0;e<s.tags.length;e++){let t="tag";Boolean(s.tags[e].male)?t="male":Boolean(s.tags[e].female)&&(t="female"),l.tagList.push({type:t,name:s.tags[e].tag})}if(t)for(let e=0;e<s.files.length;e++)l.fileList.push({index:e,hash:s.files[e].hash,extension:s.files[e].name.split(".").pop(),hasAvif:Boolean(s.files[e].hasavif),hasWebp:Boolean(s.files[e].haswebp),width:s.files[e].width,height:s.files[e].height});i?a(r(l)).then(function(e){const t=e.toString("utf8").split('content">')[1];void 0!==t&&["artist","group","series","character"].forEach(function(e,n,i){var a;null===(a=t.match(RegExp(`(?<=/${e}/)[a-z0-9%]+(?=-all\\.html)`,"g")))||void 0===a||a.forEach(function(t,n,i){l[`${e}List`].push(decodeURIComponent(t))})}),n(l)}).catch(o):n(l)}).catch(o)})}},e.getIdList=l,e.getParsedTagList=function(e){const t=e.split(" ");if(t.length<1)throw new Error("Lack of tag");{let e=[],n=[];for(let i=0;i<t.length;i++){const a=t[i].replace(/^-/,"").split(":");if(2!==a.length||void 0===a[0]||void 0===a[1]||""===a[0]||""===a[1]||!/^(artist|group|type|language|series|tag|male|female)$/.test(a[0])||!/^[^-_\.][a-z0-9-_.]+$/.test(a[1]))throw new Error("Invalid tag");{const r=`${a[0]}:${a[1]}`;if(n.includes(r))throw new Error("Duplicated tag");e.push({type:a[0],name:a[1],isNegative:t[i].startsWith("-")}),n.push(r)}}return e}},e.getQueriedIdList=function(e){return new Promise(function(t,i){if(e.length<1)throw new Error("Lack of tag");{e.sort(function(e,t){const[n,i]=[void 0!==e.isNegative&&e.isNegative,void 0!==t.isNegative&&t.isNegative];return n||i?n?1:-1:0});let r=new Set,s=e.map(function(e,t,i){return new Promise(function(t,i){a(o(e)).then(function(e){const i=n(e),a=new DataView(i),r=a.byteLength/4;let o=new Set;for(let e=0;e<r;e++)o.add(a.getInt32(4*e,!1));t(o)}).catch(i)})});return s.push(new Promise(function(e,t){e(new Set)})),void 0!==e[0].isNegative&&e[0].isNegative&&(e.unshift({type:"female",name:"yandere"}),s.unshift(new Promise(function(e,t){l({startIndex:0}).then(function(t){e(new Set(t))}).catch(t)}))),void s.reduce(function(t,n,i,a){return t.then(function(t){const a=i-1;if(0===a)r=t;else{const n=void 0!==e[a].isNegative&&e[a].isNegative;r.forEach(function(e,i,a){n===t.has(e)&&r.delete(e)})}return n})}).then(function(e){t(Array.from(r))}).catch(i)}})},e.getTagList=function(e,t){return new Promise(function(n,i){if(("language"===e||"type"===e||void 0!==t&&void 0!==t.startWith)&&("language"!==e&&"type"!==e||void 0===t||void 0===t.startWith))if("type"===e)n([{type:"type",name:"doujinshi"},{type:"type",name:"manga"},{type:"type",name:"artistcg"},{type:"type",name:"gamecg"},{type:"type",name:"anime"}]);else{const r=t.startWith;a(s(e,{startWith:r})).then(function(t){let i="";i="language"===e?'(?<=")(?!all)[a-z]+(?=":)':`(?<=/tag/${"male"===e||"female"===e?e+"%3A":""})[a-z0-9%]+(?=-all\\.html)`;const a=t.toString("utf8").match(RegExp(i,"g"))||[],o=RegExp(`^(?=[${r}])[a-z0-9%]+$`);let s=[];for(let t=0;t<a.length;t++){const n=decodeURIComponent(a[t]);null!==a[t].match(o)&&s.push({type:e,name:n})}n(s)}).catch(i)}else i(new Error("Invalid startingCharacter"))})}}(hitomi||(hitomi={})),exports.default=hitomi;