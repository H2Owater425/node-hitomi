"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const https_1=require("https"),tls_1=require("tls");var hitomi;!function(e){const t=/^(1(0(0[02-39]?|1[0-7]?|2[0-68]?|3[29]|4[25]|5[25-68]|6[1-24-9]|7[058]|8[0-1357-8]?|9[2479]?)?|1(0[14-58]?|1[0-146]|2[0-2469]?|3[13-6]?|4[0-47]?|5[14-68]?|6[02-6]|7[0-59]?|8[0-13-58-9]?|9[3-48-9])|2(0[13-46-9]?|1[03-5]?|2[4-6]|3[0-368-9]|4[2-37-9]|5[0-25-68-9]|6[0-35-6]?|7[0-359]?|8[137-8]?|9[1-258-9]?)?|3(0[24-68]|1[03-46-79]|2[0-14-58]|3[158-9]?|4[0-7]|5[1-24-79]?|6[024-57-8]?|7[5-68]|8[1359]|9[0-357-9])?|4(0[14-68]|1[1-246]?|2[17-9]|3[3-79]?|4[03-479]|5[0-135-8]?|6[1-25-9]?|7[1-37-9]?|8[13-8]|9[1-368]?)|5(0[0-24-58-9]|1[13-6]?|2[136]?|3[1-358]?|4[0-13]|5[0-136-8]?|6[0-27-9]?|7[048]?|8[0-158]|9[02-35-8]?)?|6(0[38]|1[38-9]|2[24-57-9]?|3[03-58]|49|5[057]|6[0-35-9]?|7[024-579]?|8[0257-8]?|9[249]?)?|7(0[03-57-9]|1[036-8]?|2[024-59]|3[13-8]|4[13-4]|5[137]|6[059]?|7[0-279]?|8[0-36-79]?|9[3-5]?)?|8(0[4-68]?|1[0-37]|2[1-368-9]|3[0-1358-9]?|4[1469]|5[1-37-8]?|6[0-146-7]?|7[0-2469]|8[0-13579]|9[02-38]?)?|9(0[2-9]?|1[1357]|2[026-9]|3[1-579]?|4[0-14-7]|5[024-57]|6[2-35-69]?|7[16-9]?|8[0-138-9]|9[0-37])?)?|2(0(0[1-357-9]|1[04-6]|2[1-46-79]?|3[2-35]?|4[0358]|5[02-379]?|6[1-46-7]?|7[0-14-57-8]|8[15-7]|9[1-35-6])|1(0[24]|1[03579]?|2[0-13-68-9]?|3[02-35-6]?|4[037]?|5[13-4]|6[0-14-7]?|7[2-468]?|8[1-35-68-9]|9[13-57-9]?)|2(0[0-15]?|1[24-57-8]?|2[1-24-9]?|3[1379]?|4[4-79]?|5[059]?|6[0-24-68-9]?|7[059]?|8[25-9]?|9[0-1469])?|3(0[0-24-58-9]|1[02-37-9]|2[2-35-8]|3[2-35-9]|4[05-69]|5[0-1579]|6[68]|7[25-8]?|8[1-2468-9]|9[02-369]?)?|4(0[04-57-9]|1[36]|2[25-7]?|3[026-9]|4[35-79]?|5[0-13-57]|6[6-9]|7[1-268]|8[246-9]|9[2-358]?)|5(0[0-169]|1[0247-8]?|2[0-1]|3[02-7]|4[0-25-69]?|5[02-79]?|6[1-2]|7[0-25-69]?|8[1-3]|9[2-379])|6(0[0246]|1[2-79]?|2[1358]?|3[0-1468-9]?|4[25-9]|5[135]?|6[15-68]|7[0-579]?|8[14-58]|9[1-24-8]?)?|7(0[0-35-68-9]?|1[1-46-8]|2[24-5]?|3[25-6]?|4[028]?|5[1-27-8]|6[249]|7[18]|8[0-13-46-9]?|9[026-8]?)?|8(0[1-368-9]?|1[0-6]?|2[02468-9]?|3[0-7]?|4[1-58-9]?|5[0-1357]?|6[248-9]?|7[1-25-68]|8[1-25-69]?|9[04-6]?)?|9(0[037-8]|16?|2[024-58-9]?|3[2-468]|4[0-157-9]?|5[158-9]?|6[02-5]?|7[4-79]|8[02-57-9]?|9[1-25-6]))?|3(0(0[0-15-68-9]|1[0-4]|2[0-25-6]?|3[24-58]?|4[2-57-9]?|5[0-137-8]|6[4-79]|7[1-247]?|8[0-13-48]?|9[0-13-58]?)|1(0[1-35-7]?|1[0-14-59]?|2[05-7]|3[13-6]?|4[1-35-68-9]?|5[4-58-9]?|6[03-47]|7[3-48]?|8[1-46-8]|9[35-79])|2(0[048]?|1[0-18]?|2[18-9]?|3[13-469]?|4[0-24-68-9]?|5[0-25-69]|6[26-7]?|7[0-13-48]?|8[3-46-8]|9[0-168-9])?|3(0[02-36-79]|1[0-35]|2[025-68]?|3[469]|4[1-24]|5[1-35]|6[0-3]?|7[13-8]?|8[02-36-7]|9[0-369]?)?|4(0[0-2469]|1[1-246-8]?|2[0-247-9]?|3[2-379]|4[1358-9]?|5[24-58]?|6[18-9]|7[0-13-57]?|8[035-9]|9[0-13-57-9]?)?|5(0[0-26-7]|1[15-6]|2[0246-7]|3[13-46]|4[038-9]|5[0-27-8]|6[135-8]?|7[0-14-6]?|8[35-68-9]|9[1-27-8]?)|6(0[1-469]?|1[0-14-58-9]|2[024-68]?|3[247-8]|4[14-59]?|5[0-25-6]?|6[0-17-9]?|7[1-24-57-9]?|8[1-36-9]?|9[04-68-9])|7(0[0-14-69]|1[0-1357]?|2[068]?|3[0-13-57]|4[6-9]?|5[4-69]?|6[27-8]?|7[13-468]?|8[5-79]|9[6-9])?|8(0[057-9]?|1[2-57-8]?|2[0-247-8]|3[0-24-5]?|4[03-47-8]|5[036-7]|6[0-13579]?|7[24-79]?|8[025]|9[2-359]?)|9(0[02-35-9]?|1[68]|2[02-5]?|3[2-479]?|4[1357-8]?|5[0-16-7]|6[0-136-8]?|7[0-14-57-9]?|8[47-9]?|9[0-26-79]))|4(0(0[0-68-9]|1[13-469]?|2[02-6]?|3[1-35-6]?|4[246-7]?|5[0-28]?|6[1-279]?|76|8[0-14-579]|9[0-24]?)?|1[1-24-9]|2[0-14-57-9]?|3[1-36-8]|4[3-7]|5[2-357]|6[2-358-9]?|7[027-9]?|8[0-13-69]|9[2-579])|5(0[1-29]?|1[02-36-9]?|2[0-14-8]|3[03-479]|4[025]?|5[138-9]?|6[2-5]?|7[1-357-8]|84|9[1-24-69])|6(0[0469]?|1[0-35-68-9]|2[246-79]|3[1579]|4[2-8]?|5[0-579]?|6[35-6]?|7[13-4]?|8[1-257]?|9[1-358-9]?)|7(0[0-13-468]?|1[2-36-79]|2[024-58-9]?|3[02-59]?|4[68]|5[0-359]|6[0579]|7[1-357-8]|8[02-579]?|9[1-68-9])|8(0[0-26-79]|1[146-8]?|2[0-59]?|3[057]?|4[0-2479]|5[0-14-5]?|6[1-24-58]|7[0-24-57-9]|8[02-35-9]?|9[046-9]?)?|9(0[0-249]|1[3-79]?|2[03-69]|3[249]|4[0-13-468-9]?|5[24-68]?|6[0-37-9]|7[05-9]|8[0-15]?|9[0-13-46-79])?)$/,n=["artist","group","parody","character"];class a extends Error{constructor(e,t){super("Unknown"),this.code=e;const n=t.includes("'")?"`":"'";switch(t=n+t+n,e){case"INVALID_VALUE":this.message="Value of "+t+" was not valid";break;case"DUPLICATED_ELEMENT":this.message="Element of "+t+" was duplicated";break;case"LACK_OF_ELEMENT":this.message="Elements of "+t+" was not enough";break;case"REQEUST_REJECTED":this.message="Request to "+t+" was rejected"}}get name(){return"HitomiError ["+this.code+"]"}}function s(e){return Number.parseInt(e)===Number(e)&&Number.isFinite(e)&&"object"!=typeof e}function i(e,t={}){const n=t.splitBy||4;let a=new ArrayBuffer(e.byteLength),s=new Uint8Array(a);for(let t=0;t<e.byteLength;++t)s[t]=e[t];const i=new DataView(a),l=i.byteLength/n;let r=new Set;for(let e=0;e<l;e++)r.add(i.getInt32(e*n,!1));return r}const l=new class extends https_1.Agent{createConnection(e,t){return(0,tls_1.connect)(Object.assign(e,{servername:void 0}),t)}};function r(e,t={}){return new Promise((function(n,s){const i=new URL(e);(0,https_1.request)({hostname:i.hostname,path:i.pathname,method:"GET",port:443,headers:Object.assign(t,{Accept:"*/*",Connection:"keep-alive",Referer:"https://hitomi.la"}),agent:l},(function(t){let i=[],l=0;switch(t.statusCode){case 200:case 206:t.on("data",(function(e){i.push(e),l+=e.byteLength})).on("error",(function(){s(new a("REQEUST_REJECTED",e))})).on("end",(function(){n(Buffer.concat(i,l))}));break;default:s(new a("REQEUST_REJECTED",e))}})).on("error",(function(){s(new a("REQEUST_REJECTED",e))})).end()}))}function o(e,t={}){if("language"!==e.type||void 0===t.orderBy){let n="",a="",s="all";switch(e.type){case"male":case"female":n="tag/",a=e.type+":"+e.name.replace(/_/g," ");break;case"language":a=t.orderBy||"index",s=e.name;break;default:n=e.type+"/",a=e.name.replace(/_/g," ")}return"https://ltn.hitomi.la/n/"+n+a+"-"+s+".nozomi"}throw new a("INVALID_VALUE","options['orderBy']")}function c(e,t={}){if("language"!==e||void 0===t.startWith){let n="https://hitomi.la/";switch(e){case"tag":case"male":case"female":n+="alltags-";break;case"artist":n+="allartists-";break;case"series":n+="allseries-";break;case"character":n+="allcharacters-";break;case"group":n+="allgroups-";break;case"language":n="ltn."+n+"language_support.js";break;default:throw new a("INVALID_VALUE","extension")}if("language"!==e){switch(e){case"male":n+="m";break;case"female":n+="f";break;default:"0-9"===t.startWith?n+="123":n+=t.startWith}return n+".html"}return n}throw new a("INVALID_VALUE","options['startWith']")}e.getNozomiUrl=o,e.getTagUrl=c,e.getImageUrl=function(e,n,i={}){const l=i.isThumbnail||!1,r=i.isSmall||!1;if(!r||l&&"avif"===n){switch(n){case"jpg":case"png":case"gif":if(!l&&e.extension===n)break;case"webp":case"avif":if(e["has"+n.charAt(0).toUpperCase()+n.slice(1)])break;default:throw new a("INVALID_VALUE","extension")}if(/^[0-9a-f]{64}$/.test(e.hash)){if(s(e.index)&&e.index>=0){const a=String(Number.parseInt(e.hash.slice(-1)+e.hash.slice(-3,-1),16));let s=t.test(a)?"a":"b",i="",o="";return l?(i=e.hash.slice(-1)+"/"+e.hash.slice(-3,-1)+"/"+e.hash,s+="tn",o=n+(r&&"avif"===n?"small":"")+"bigtn"):(i="1645030801/"+a+"/"+e.hash,"jpg"===n||"png"===n?(s+="b",o="images"):(s+="a",o=n)),"https://"+s+".hitomi.la/"+o+"/"+i+"."+n}throw new a("INVALID_VALUE","image['index']")}throw new a("INVALID_VALUE","image['hash']")}throw new a("INVALID_VALUE","extension")},e.getVideoUrl=function(e){if("anime"===e.type)return"https://streaming.hitomi.la/videos/"+e.title.display.toLowerCase().replace(/\s/g,"-")+".mp4";throw new a("INVALID_VALUE","gallery['type']")},e.getGalleryUrl=function(e){return("https://hitomi.la/"+("artistcg"!==e.type?e.type:"cg")+"/"+encodeURIComponent(Buffer.from(e.title.japanese||e.title.display).slice(0,200).toString("utf-8")).replace(/\(|\)|'|%(2[0235F]|3[CEF]|5[BD]|7[BD])/g,"-")+(null!==e.languageName.local?"-"+encodeURIComponent(e.languageName.local):"")+"-"+e.id+".html").toLocaleLowerCase()},e.getSecondThumbnailIndex=function(e){return Math.ceil((e.files.length-1)/2)},e.getGallery=function(e,t={}){if(s(e)&&e>0)return new Promise((function(a,s){r("https://ltn.hitomi.la/galleries/"+e+".js").then((function(s){var i,l;const r=JSON.parse(s.toString("utf8").slice(18));let o=JSON.parse('{ "id": '+e+', "title": { "display": "'+r.title.replace(/\"/g,'\\"')+'", "japanese": '+(null!==r.japanese_title?'"'+r.japanese_title.replace(/\"/g,'\\"')+'"':"null")+' }, "type": "'+r.type+'", "languageName": { "english": '+(null!==r.language?'"'+r.language+'"':"null")+', "local": '+(null!==r.language_localname?'"'+r.language_localname+'"':"null")+' }, "artists": [], "groups": [], "series": [], "characters": [], "tags": [], "files": [], "publishedDate": null, "translations": [], "relatedIds": [] }');for(let e=0;e<n.length;e++){const t=n[e]+"s";if(null!==r[t])for(let a=0;a<r[t].length;a++)o["parodys"!==t?t:"series"].push(r[t][a][n[e]])}if(null!==r.tags)for(let e=0;e<r.tags.length;e++){let t="tag";Boolean(r.tags[e].male)?t="male":Boolean(r.tags[e].female)&&(t="female"),o.tags.push({type:t,name:r.tags[e].tag})}if(null===(i=t.includeFiles)||void 0===i||i)for(let e=0;e<r.files.length;e++)o.files.push({index:e,hash:r.files[e].hash,extension:r.files[e].name.split(".").pop(),hasAvif:Boolean(r.files[e].hasavif),hasWebp:Boolean(r.files[e].haswebp),width:r.files[e].width,height:r.files[e].height});if(o.publishedDate=new Date(r.date),null!==(l=t.includeRelatedIds)&&void 0!==l&&l){for(let e=0;e<r.languages.length;e++)o.translations.push({id:Number(r.languages[e].galleryid),languageName:{english:r.languages[e].name,local:r.languages[e].language_localname}});o.relatedIds=r.related}a(o)})).catch(s)}));throw new a("INVALID_VALUE","id")},e.getIds=function e(t={}){return new Promise((function(n,l){var c,g,h,u,d,p,f;const[m,w]=[s(null===(c=t.range)||void 0===c?void 0:c.startIndex),s(null===(g=t.range)||void 0===g?void 0:g.endIndex)];!m||(null===(h=t.range)||void 0===h?void 0:h.startIndex)>=0?!w||(null===(u=t.range)||void 0===u?void 0:u.endIndex)>=(null===(d=t.range)||void 0===d?void 0:d.startIndex)?Array.isArray(t.tags)&&0!==t.tags.length?void 0===t.orderBy||"index"===t.orderBy?t.tags.reduce((function(e,t){return e.then((function(e){return new Promise((function(n,a){r(o(t)).then((function(a){const s=t.isNegative||!1,l=i(a);e.forEach((function(t){s===l.has(t)&&e.delete(t)})),n(e)})).catch(a)}))}))}),t.tags[0].isNegative?new Promise((function(t,n){e().then((function(e){t(new Set(e))})).catch(n)})):new Promise((function(e,n){r(o(t.tags.shift())).then((function(t){e(i(t))})).catch(n)}))).then((function(e){var a,s;let i=Array.from(e).slice(null===(a=t.range)||void 0===a?void 0:a.startIndex,null===(s=t.range)||void 0===s?void 0:s.endIndex);t.reverseResult?n(i):n(i.reverse())})).catch(l):l(new a("INVALID_VALUE","options['orderBy']")):r("https://ltn.hitomi.la/"+(t.orderBy||"index")+"-all.nozomi",{Range:"bytes="+(m?4*(null===(p=t.range)||void 0===p?void 0:p.startIndex):"0")+"-"+(w?4*(null===(f=t.range)||void 0===f?void 0:f.endIndex)+3:"")}).then((function(e){let a=Array.from(i(e));t.reverseResult?n(a):n(a.reverse())})).catch(l):l(new a("INVALID_VALUE","options['range']['endIndex']")):l(new a("INVALID_VALUE","options['range']['startIndex']"))}))},e.getParsedTags=function(e){const t=e.split(" ");if(0!==t.length){let e=[],n=new Set;for(let s=0;s<t.length;s++){const i=t[s].replace(/^-/,"").split(":");if(2!==i.length||!/^(artist|group|type|language|series|tag|male|female)$/.test(i[0])||!/^[^-_\.][a-z0-9-_.]+$/.test(i[1]))throw new a("INVALID_VALUE","splitTagStrings["+s+"]");{const l=i[0]+":"+i[1];if(n.has(l))throw new a("DUPLICATED_ELEMENT","splitTagStrings["+s+"]");e.push({type:i[0],name:i[1],isNegative:t[s].startsWith("-")}),n.add(l)}}return e}throw new a("LACK_OF_ELEMENT","splitTagStrings")},e.getTags=function(e,t={}){return new Promise((function(n,s){(void 0===t.startWith?"language"===e||"type"===e:"language"!==e&&"type"!==e)?"type"!==e?r(c(e,{startWith:t.startWith})).then((function(t){const a=t.toString("utf8").match(RegExp("language"===e?'(?<=")(?!all)[a-z]+(?=":)':"(?<=/tag/"+("male"===e||"female"===e?e+"%3A":"")+")[a-z0-9%]+(?=-all\\.html)","g"))||[];let s=[];for(let t=0;t<a.length;t++)s.push({type:e,name:decodeURIComponent(a[t])});n(s)})).catch(s):n([{type:"type",name:"doujinshi"},{type:"type",name:"manga"},{type:"type",name:"artistcg"},{type:"type",name:"gamecg"},{type:"type",name:"anime"}]):s(new a("INVALID_VALUE","options['startWith']"))}))}}(hitomi||(hitomi={})),exports.default=hitomi;