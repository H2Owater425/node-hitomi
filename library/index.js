"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const https_1=require("https"),tls_1=require("tls");var hitomi;!function(e){class t extends Error{constructor(e,...t){super(function(e,...t){switch(e){case"INVALID_VALUE":return"Value of '"+t[0]+"' was not valid";case"DUPLICATED_ELEMENT":return"Element of '"+t[0]+"' was duplicated";case"LACK_OF_ELEMENT":return"Elements of '"+t[0]+"' was not enough";case"REQEUST_REJECTED":return"Request to '"+t[0]+"' was rejected"}}(e,t)),this.code=e}get name(){return"HitomiError ["+this.code+"]"}}function n(e){return!(Number.parseInt(e)!==Number(e)||!Number.isFinite(e)||"object"==typeof e)}function a(e,t){const n=(null==t?void 0:t.splitBy)||4;let a=new ArrayBuffer(e.byteLength),i=new Uint8Array(a);for(let t=0;t<e.byteLength;++t)i[t]=e[t];const l=new DataView(a),s=l.byteLength/n;let o=new Set;for(let e=0;e<s;e++)o.add(l.getInt32(e*n,!1));return o}const i=new class extends https_1.Agent{createConnection(e,t){return e.servername=void 0,tls_1.connect(e,t)}}({rejectUnauthorized:!1,keepAlive:!0});function l(e,n){return new Promise(function(a,l){const s=new URL(e);https_1.request({hostname:s.hostname,path:s.pathname,method:"GET",port:443,headers:Object.assign({Accept:"*/*",Connection:"keep-alive"},n),agent:i},function(n){let i=[],s=0;200===n.statusCode?n.on("data",function(e){i.push(e),s+=e.byteLength}).on("error",function(n){l(new t("REQEUST_REJECTED",e))}).on("end",function(){a(Buffer.concat(i,s))}):l(new t("REQEUST_REJECTED",e))}).on("error",function(n){l(new t("REQEUST_REJECTED",e))}).end()})}function s(e){return("https://hitomi.la/"+("artistcg"!==e.type?e.type:"cg")+"/"+encodeURIComponent(Buffer.from(e.title.japanese||e.title.display).slice(0,200).toString("utf-8")).replace(/\(|\)|'|%(2(0|2|3|5|F)|3(C|E|F)|5(B|D)|7(B|D))/g,"-")+(null!==e.languageName.local?"-"+encodeURIComponent(e.languageName.local):"")+"-"+e.id+".html").toLocaleLowerCase()}function o(e,n){if("language"!==e.type&&void 0!==(null==n?void 0:n.orderBy))throw new t("INVALID_VALUE","option['orderBy']");{const t=(null==n?void 0:n.orderBy)||"index";let a="",i="",l="all";switch(e.type){case"male":case"female":a="tag/",i=e.type+":"+e.name.replace(/_/g," ");break;case"language":i=t,l=e.name;break;default:a=e.type+"/",i=e.name.replace(/_/g," ")}return"https://ltn.hitomi.la/n/"+a+i+"-"+l+".nozomi"}}function r(e,t){const n=t.startWith;let a="hitomi.la/";switch(e){case"tag":case"male":case"female":a+="alltags-";break;case"artist":a+="allartists-";break;case"series":a+="allseries-";break;case"character":a+="allcharacters-";break;case"group":a+="allgroups-";break;case"language":a="ltn."+a+"language_support.js"}return a="https://"+a,"language"!==e?(a+="male"===e?"m":"female"===e?"f":"0-9"!==n?n:"123")+".html":a}function c(e,i){return new Promise(function(s,o){var r;if(!n(e.startIndex)||n(e.startIndex)&&e.startIndex<0)o(new t("INVALID_VALUE","range['startIndex']"));else if(void 0!==e.endIndex&&(!n(e.endIndex)||n(e.endIndex)&&e.endIndex<=e.startIndex))o(new t("INVALID_VALUE","range['endIndex']"));else{const t=4*e.startIndex,n=t+4*((null==e?void 0:e.endIndex)||NaN)+3||"",c=(null==i?void 0:i.orderBy)||"index",u=null!==(r=null==i?void 0:i.reverseResult)&&void 0!==r&&r;l("https://ltn.hitomi.la/"+c+"-all.nozomi",{Range:"bytes="+t+"-"+n}).then(function(e){let t=Array.from(a(e));s(u?t:t.reverse())}).catch(o)}})}e.getImageUrl=function(e,a,i){var l;const s=null!==(l=null==i?void 0:i.isThumbnail)&&void 0!==l&&l;switch(a){case"jpg":if("jpg"!==e.extension)throw new t("INVALID_VALUE","extension");break;case"png":if(s||"png"!==e.extension)throw new t("INVALID_VALUE","extension");break;case"avif":if(e.hasAvif)break;throw new t("INVALID_VALUE","extension");case"webp":if(s||!e.hasWebp)throw new t("INVALID_VALUE","extension");break;case"gif":if(s||"gif"!==e.extension)throw new t("INVALID_VALUE","extension")}if(/^[0-9a-f]{64}$/.test(e.hash)){if(!n(e.index)||e.index<0)throw new t("INVALID_VALUE","image['index']");{const t=e.hash.slice(-1)+"/"+e.hash.slice(-3,-1)+"/"+e.hash;let n="",i="";if(s)n="tn",i=("avif"===a?"avif":"")+"bigtn";else{let t=Number.parseInt(e.hash.slice(-3,-1),16),l=0;t<68?l=2:t<136&&(l=1),n=String.fromCharCode(l+97),"jpg"===a||"png"===a?(n+="b",i="images"):(n+="a",i=a)}return"https://"+n+".hitomi.la/"+i+"/"+t+"."+a}}throw new t("INVALID_VALUE","image['hash']")},e.getVideoUrl=function(e){return"https://streaming.hitomi.la/videos/"+e.title.display.toLowerCase().replace(/\s/g,"-")+".mp4"},e.getGalleryUrl=s,e.getNozomiUrl=o,e.getTagUrl=r,e.getSecondThumbnailIndex=function(e){return Math.ceil((e.fileList.length-1)/2)},e.getGallery=function(e,a){var i,o;if(!n(e)||n(e)&&e<1)throw new t("INVALID_VALUE","id");{const t=null===(i=null==a?void 0:a.includeFiles)||void 0===i||i,n=null===(o=null==a?void 0:a.includeFullData)||void 0===o||o;return new Promise(function(a,i){l("https://ltn.hitomi.la/galleries/"+e+".js").then(function(e){const o=JSON.parse(e.toString("utf8").slice(18));let r=JSON.parse('{ "id": '+o.id+', "title": { "display": "'+o.title.replace(/\"/g,'\\"')+'", "japanese": '+(null!==o.japanese_title?'"'+o.japanese_title.replace(/\"/g,'\\"')+'"':"null")+' }, "type": "'+o.type+'", "languageName": { "english": '+(null!==o.language?'"'+o.language+'"':"null")+', "local": '+(null!==o.language_localname?'"'+o.language_localname+'"':"null")+' }, "artistList": [], "groupList": [], "seriesList": [], "characterList": [], "tagList": [], "fileList": [], "publishedDate": null }');if(r.publishedDate=new Date(o.date),null!==o.tags)for(let e=0;e<o.tags.length;e++){let t="tag";Boolean(o.tags[e].male)?t="male":Boolean(o.tags[e].female)&&(t="female"),r.tagList.push({type:t,name:o.tags[e].tag})}if(t)for(let e=0;e<o.files.length;e++)r.fileList.push({index:e,hash:o.files[e].hash,extension:o.files[e].name.split(".").pop(),hasAvif:Boolean(o.files[e].hasavif),hasWebp:Boolean(o.files[e].haswebp),width:o.files[e].width,height:o.files[e].height});n?l(s(r)).then(function(e){const t=e.toString("utf8").split('content">')[1];void 0!==t&&["artist","group","series","character"].forEach(function(e,n,a){var i;null===(i=t.match(RegExp("(?<=/"+e+"/)[A-z0-9%]+(?=-all\\.html)","g")))||void 0===i||i.forEach(function(t,n,a){r[e+"List"].push(decodeURIComponent(t))})}),a(r)}).catch(i):a(r)}).catch(i)})}},e.getIdList=c,e.getParsedTagList=function(e){const n=e.split(" ");if(n.length<1)throw new t("LACK_OF_ELEMENT","splittedTagStringList");{let e=[],a=[];for(let i=0;i<n.length;i++){const l=n[i].replace(/^-/,"").split(":");if(2!==l.length||void 0===l[0]||void 0===l[1]||""===l[0]||""===l[1]||!/^(artist|group|type|language|series|tag|male|female)$/.test(l[0])||!/^[^-_\.][a-z0-9-_.]+$/.test(l[1]))throw new t("INVALID_VALUE","splittedTagStringList["+i+"]");{const s=l[0]+":"+l[1];if(a.includes(s))throw new t("DUPLICATED_ELEMENT","tagList");e.push({type:l[0],name:l[1],isNegative:n[i].startsWith("-")}),a.push(s)}}return e}},e.getQueriedIdList=function(e){return new Promise(function(n,i){var s;if(e.length<1)throw new t("LACK_OF_ELEMENT","tagList");{e.sort(function(e,t){var n,a;const[i,l]=[null!==(n=null==e?void 0:e.isNegative)&&void 0!==n&&n,null!==(a=null==t?void 0:t.isNegative)&&void 0!==a&&a];return i||l?i?1:-1:0});let t=new Set,r=e.map(function(e,t,n){return new Promise(function(t,n){l(o(e)).then(function(e){t(a(e))}).catch(n)})});return r.push(new Promise(function(e,t){e(new Set)})),null!==(s=e[0].isNegative)&&void 0!==s&&s&&(e.unshift({type:"female",name:"yandere"}),r.unshift(new Promise(function(e,t){c({startIndex:0}).then(function(t){e(new Set(t))}).catch(t)}))),void r.reduce(function(n,a,i,l){return n.then(function(n){var l;const s=i-1;if(0===s)t=n;else{const a=null!==(l=e[s].isNegative)&&void 0!==l&&l;t.forEach(function(e,i,l){a===n.has(e)&&t.delete(e)})}return a})}).then(function(e){n(Array.from(t))}).catch(i)}})},e.getTagList=function(e,n){return new Promise(function(a,i){if("language"!==e&&"type"!==e&&void 0===(null==n?void 0:n.startWith)||("language"===e||"type"===e)&&void 0!==(null==n?void 0:n.startWith))i(new t("INVALID_VALUE","startingCharacter"));else if("type"===e)a([{type:"type",name:"doujinshi"},{type:"type",name:"manga"},{type:"type",name:"artistcg"},{type:"type",name:"gamecg"},{type:"type",name:"anime"}]);else{const t=n.startWith;l(r(e,{startWith:t})).then(function(n){let i="";i="language"===e?'(?<=")(?!all)[a-z]+(?=":)':"(?<=/tag/"+("male"===e||"female"===e?e+"%3A":"")+")[a-z0-9%]+(?=-all\\.html)";const l=n.toString("utf8").match(RegExp(i,"g"))||[],s=RegExp("^(?=["+t+"])[a-z0-9%]+$");let o=[];for(let t=0;t<l.length;t++){const n=decodeURIComponent(l[t]);null!==l[t].match(s)&&o.push({type:e,name:n})}a(o)}).catch(i)}})}}(hitomi||(hitomi={})),exports.default=hitomi;