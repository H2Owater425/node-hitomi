"use strict";const e=require("crypto"),t=require("https"),a=require("tls"),n=["artist","group","parody","character"],s=new Set(["artist","group","type","language","series","character","male","female","tag"]),r=Symbol("isNegative"),i=Symbol("pathCode"),o=Symbol("startsWithA"),l=Symbol("subdomainCodes");class c extends Error{constructor(e,...t){switch(e){case 0:super(t[0]+" must "+(1===t.length?"be valid":t[1])),this.name="INVALID_VALUE";break;case 1:super(t[0]+" must "+t[1]),this.name="INVALID_CALL";break;case 2:super(t[0]+" must not be duplicated"),this.name="DUPLICATED_ELEMENT";break;case 3:super(t[0]+" must have more elements"),this.name="LACK_OF_ELEMENT";break;case 4:super("Request to '"+t[0].replace(/'/g,"\\'")+"' was rejected"),this.name="REQEUST_REJECTED";break;default:throw null}this.name="HitomiError ["+this.name+"]"}}const g=new class extends t.Agent{createConnection(e,t){return a.connect(Object.assign(e,{servername:void 0}),t)}};function u(e,a={}){return new Promise((function(n,s){const r=e.indexOf("/");t.request({hostname:e.slice(0,r),path:e.slice(r),method:"GET",port:"443",agent:g,headers:Object.assign(a,{accept:"*/*",connection:"keep-alive",referer:"https://hitomi.la"})},(function(t){const a=[];let r=0;switch(t.statusCode){case 200:case 206:t.on("data",(function(e){a.push(e),r+=e.byteLength})).once("error",s).once("end",(function(){n(Buffer.concat(a,r))}));break;default:s(new c(4,"https://"+e))}})).once("error",s).end()}))}function f(e,t=!1){const a=new Set;a[r]=t;for(let t=0;t<e.byteLength;t+=4)a.add(e.readInt32BE(t));return a}function h(e,t){return u("ltn.hitomi.la/galleriesindex/galleries."+t+".index",{range:"bytes="+e+"-"+(e+463n)}).then((function(e){return 0!==e.length?function(e){const t={keys:[],datas:[],subnodeAddresses:[]};let a=0;const n=e.readInt32BE(a);a+=4;for(let s=0;s<n;s++){const n=e.readInt32BE(a);if(!(n>0&&n<32))throw new c(0,"keySize","between 1 and 31");a+=4,t.keys.push(e.subarray(a,a+n)),a+=n}const s=e.readInt32BE(a);a+=4;for(let n=0;n<s;n++)t.datas.push([e.readBigUInt64BE(a),e.readInt32BE(a+8)]),a+=12;for(let n=0;n<17;n++)t.subnodeAddresses.push(e.readBigUInt64BE(a)),a+=8;return t}(e):void 0}))}function d(e,t,a){if(0!==t.keys.length){let n=-1,s=0;for(;s<t.keys.length&&(n=e.compare(t.keys[s]),!(n<=0));)s++;if(0===n)return Promise.resolve(t.datas[s]);if(0n===t.subnodeAddresses[s])return Promise.resolve();{let e=!0;for(let a=0;a<t.subnodeAddresses.length;a++)if(0n!==t.subnodeAddresses[a]){e=!1;break}if(e)return Promise.resolve()}return h(t.subnodeAddresses[s],a).then((function(t){return"object"==typeof t?d(e,t,a):void 0}))}return Promise.resolve()}function p(e={}){let t="index",a="all";if("object"==typeof e.tag)switch(e.tag.type){case"male":case"female":t="tag/"+e.tag.type+":"+encodeURIComponent(e.tag.name);break;case"language":a=e.tag.name;break;default:t=e.tag.type+"/"+encodeURIComponent(e.tag.name)}else"string"==typeof e.popularityOrderBy&&(t="day"!==e.popularityOrderBy?e.popularityOrderBy:"today");return"ltn.hitomi.la/"+("string"!=typeof e.popularityOrderBy?"n":"popular")+"/"+t+"-"+a+".nozomi"}function m(e,t){const a="language"===e;if("string"==typeof t!==a){let n="ltn.",s="all";if(a)s="language_support";else{switch(n="",e){case"tag":case"male":case"female":s+="tags";break;case"artist":case"series":case"character":case"group":s+=e,e.endsWith("s")||(s+="s");break;default:throw new c(0,"type")}s+="-"+("0-9"!==t?t:"123")+".html"}return n+"hitomi.la/"+s}throw new c(0,"startsWith","not be used only with language")}function y(e){if("anime"===e.type)return"streaming.hitomi.la/videos/"+e.title.display.toLowerCase().replace(/\s/g,"-")+".mp4";throw new c(0,"gallery['type']","be 'anime'")}function b(e){return("hitomi.la/"+("artistcg"!==e.type?e.type:"cg")+"/"+encodeURIComponent(Buffer.from(e.title.japanese||e.title.display).subarray(0,200).toString("utf-8")).replace(/\(|\)|'|%(2[0235F]|3[CEF]|5[BD]|7[BD])/g,"-")+(null!==e.languageName.local?"-"+encodeURIComponent(e.languageName.local):"")+"-"+e.id+".html").toLocaleLowerCase()}class w{static synchronize(){return u("ltn.hitomi.la/gg.js").then((function(e){const t=e.toString("utf-8");let a=0,n=t.indexOf("\n");for(w[l].clear();-1!==n;){switch(t[a]){case"b":w[i]=t.slice(a+4,n-2);break;case"o":w[o]="0"===t[a+4];break;case"c":w[l].add(Number(t.slice(a+5,n-1)))}a=n+1,n=t.indexOf("\n",a)}if("string"!=typeof w[i]||"boolean"!=typeof w[o]||0===w[l].size||w[l].has(NaN)){const e=w[l].size;throw w[l].clear(),new c(0,"ImageUriResolver { [Symbol(pathCode)]: '"+w[i]+"', [Symbol(startsWithA)]: "+w[o]+", [Symbol(subdomainCodes)]: Set("+e+") }")}}))}static getImageUri(e,t,a={}){if(0!==w[l].size){switch(t){case"webp":if(e.hasWebp)break;case"avif":if(e.hasAvif)break;case"jxl":if(e.hasJxl)break;default:throw new c(0,"extension")}const n=Number.parseInt(e.hash.slice(-1)+e.hash.slice(-3,-1),16);let s="a",r=t;if(a.isThumbnail){if(a.isSmall){if("avif"!==t)throw new c(0,"options['isSmall']","be used with avif");r+="small"}r+="bigtn/"+e.hash.slice(-1)+"/"+e.hash.slice(-3,-1)+"/"+e.hash,s="tn"}else r+="/"+w[i]+"/"+n+"/"+e.hash;return(w[l].has(n)===w[o]?"a":"b")+s+".hitomi.la/"+r+"."+t}throw new c(1,"ImageUriResolver.getImageUri()","be called after ImageUriResolver.synchronize()")}}function x(e){return u("ltn.hitomi.la/galleries/"+e+".js").then((function(t){const a=JSON.parse(t.toString("utf-8").slice(18)),s=JSON.parse('{"id":'+e+',"title":{"display":"'+a.title.replace(/"/g,'\\"')+'","japanese":'+("string"==typeof a.japanese_title?'"'+a.japanese_title.replace(/"/g,'\\"')+'"':"null")+'},"type":"'+a.type+'","languageName":{"english":'+(null!==typeof a.language?'"'+a.language+'"':"null")+',"local":'+(null!==typeof a.language_localname?'"'+a.language_localname+'"':"null")+'},"artists":[],"groups":[],"series":[],"characters":[],"tags":[],"files":[],"publishedDate":null,"translations":[],"relatedIds":null}');for(let e=0;e<n.length;e++){const t=n[e]+"s";if(null!==a[t])for(let r=0;r<a[t].length;r++)s[t.startsWith("p")?"series":t].push(a[t][r][n[e]])}if(Array.isArray(a.tags))for(let e=0;e<a.tags.length;e++){let t="tag";1===a.tags[e].male?t="male":1===a.tags[e].female&&(t="female"),s.tags.push({type:t,name:a.tags[e].tag})}for(let e=0;e<a.files.length;e++)s.files.push({index:e,hash:a.files[e].hash,name:a.files[e].name,hasAvif:Boolean(a.files[e].hasavif),hasWebp:Boolean(a.files[e].haswebp),hasJxl:Boolean(a.files[e].hasjxl),width:a.files[e].width,height:a.files[e].height});s.publishedDate=new Date(a.date);for(let e=0;e<a.languages.length;e++)s.translations.push({id:Number(a.languages[e].galleryid),languageName:{english:a.languages[e].name,local:a.languages[e].language_localname}});return s.relatedIds=a.related,s}))}function v(t={}){return u("ltn.hitomi.la/galleriesindex/version").then((function(a){const n="string"==typeof t.title,s=Array.isArray(t.tags)&&0!==t.tags.length,i="object"==typeof t.range,o=i&&(n||s),l=a.toString("utf-8"),g=[];if(("string"==typeof t.popularityOrderBy||i||s&&t.tags[0].isNegative)&&g.push(u(p({popularityOrderBy:t.popularityOrderBy}),o?void 0:{range:"bytes="+("number"==typeof t.range.start?4*t.range.start:"0")+"-"+("number"==typeof t.range.end?4*t.range.end-1:"")}).then(f)),n){t.title=t.title.toLocaleLowerCase()+" ";let a=0,n=t.title.indexOf(" ");for(;-1!==n;){if(n-a==0)return Promise.reject(new c(0,"options['title']","not contain continuous or edge space"));{const s=e.createHash("sha256").update(t.title.slice(a,n)).digest().subarray(0,4);g.push(h(0n,l).then((function(e){return"object"==typeof e?d(s,e,l):void 0})).then((function(e){return Array.isArray(e)?u("ltn.hitomi.la/galleriesindex/galleries."+l+".data",{range:"bytes="+(e[0]+4n)+"-"+(e[0]+BigInt(e[1])-1n)}):void 0})).then((function(e){return f("object"==typeof e?e:Buffer.from([]))})))}a=n+1,n=t.title.indexOf(" ",a)}}if(s)for(let e=0;e<t.tags.length;e++)g.push(u(p({tag:t.tags[e]})).then((function(a){return f(a,t.tags[e].isNegative)})));return g.reduce((function(e,t){return e.then((function(e){return t.then((function(t){for(const a of e)t[r]===t.has(a)&&e.delete(a);return e}))}))}),u(p()).then(f)).then((function(e){const a=Array.from(e);return o?a.slice(t.range.start,t.range.end):a}))}))}function I(e){const t=[],a=new Set;let n=0,r=(e+=" ").indexOf(" ");for(;-1!==r;){const i=e.indexOf(":",n);if(!(-1!==i&&i<r))throw new c(0,"'"+e.slice(n,r)+"'");{const o=e.startsWith("-",n),l={type:e.slice(n+(o?1:0),i),name:e.slice(i+1,r),isNegative:o};if(!s.has(l.type)){let e="be one of ";for(const t of s)e+="'"+t+"', ";throw new c(0,"'"+l.type+"'",e.slice(0,-2))}if(!/^[a-z0-9][a-z0-9-_.]*$/.test(l.name))throw new c(0,"'"+l.name+"'","match /^[a-z0-9][a-z0-9-_.]*$/");{const e=l.type+":"+l.name;if(a.has(e))throw new c(2,"'"+e+"'");l.name=l.name.replace(/_/g," "),t.push(l),a.add(e)}}n=r+1,r=e.indexOf(" ",n)}return t}function O(e,t){const a="type"===e,n="language"===e;return"string"==typeof t!==(a||n)?a?Promise.resolve([{type:"type",name:"doujinshi"},{type:"type",name:"manga"},{type:"type",name:"artistcg"},{type:"type",name:"gamecg"},{type:"type",name:"imageset"},{type:"type",name:"anime"}]):u(m(e,t)).then((function(t){const a=t.toString("utf-8"),s=[];let r,i;if(n){const e=a.indexOf("}");for(r=a.indexOf(":")+2,i=a.indexOf('"',r);i<e;)s.push({type:"language",name:a.slice(r,i)}),r=a.indexOf(":",i)+2,i=a.indexOf('"',r)}else{let t='href="/';switch(e){case"male":case"female":t+="tag/"+e+"%3A";break;default:t+=e+"/"}const n=t.length-1;if(r=a.indexOf(t)+t.length,i=a.indexOf(".",r),"tag"!==e)for(;r!==n;)s.push({type:e,name:decodeURIComponent(a.slice(r,i-4))}),r=a.indexOf(t,i)+t.length,i=a.indexOf(".",r);else for(;r!==n;)a.startsWith("male",r)||a.startsWith("female",r)||s.push({type:e,name:decodeURIComponent(a.slice(r,i-4))}),r=a.indexOf(t,i)+t.length,i=a.indexOf(".",r)}return s})):Promise.reject(new c(0,"startsWith","not be used only with type and language"))}w[l]=new Set;const U={getGallery:x,getGalleryIds:v,getParsedTags:I,getTags:O,getNozomiUri:p,getTagUri:m,getVideoUri:y,getGalleryUri:b,ImageUriResolver:w,default:{getGallery:x,getGalleryIds:v,getParsedTags:I,getTags:O,getNozomiUri:p,getTagUri:m,getVideoUri:y,getGalleryUri:b,ImageUriResolver:w}};module.exports=U;
