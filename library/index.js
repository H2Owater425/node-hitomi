"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,n){void 0===n&&(n=a),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[a]}})}:function(e,t,a,n){void 0===n&&(n=a),e[n]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,t,a,n){return new(a||(a=Promise))(function(r,i){function l(e){try{s(n.next(e))}catch(e){i(e)}}function o(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(l,o)}s((n=n.apply(e,t||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getTagUrl=exports.getNozomiUrl=exports.getGalleryUrl=exports.getImageUrl=exports.getTagList=exports.queryTag=exports.parseTag=exports.getGalleryIdList=exports.getGalleryData=void 0;const https=__importStar(require("https")),tls=__importStar(require("tls")),node_fetch_1=__importDefault(require("node-fetch"));function getGalleryData(e,t){if(!isInteger(e)||isInteger(e)&&e<1)throw Error("Invalid id value");{const a=void 0===t||void 0===t.includeFiles||t.includeFiles,n=void 0===t||void 0===t.includeFullData||t.includeFullData;return new Promise(function(t,r){node_fetch_1.default(`https://ltn.hitomi.la/galleries/${e}.js`,requestOption).then(function(e){return e.text()}).then(function(e){const r=JSON.parse(e.slice(18));let i={id:r.id,title:{display:r.title,japanese:r.japanese_title},type:r.type,languageName:{english:r.language,local:r.language_localname},artistList:[],groupList:[],seriesList:[],characterList:[],tagList:[],fileList:[],publishedDate:new Date(`${r.date}:00`.replace(" ","T"))};if(null!==r.tags)for(let e=0;e<r.tags.length;e++){let t="tag";Boolean(r.tags[e].male)?t="male":Boolean(r.tags[e].female)&&(t="female"),i.tagList.push({name:r.tags[e].tag,type:t})}if(a)for(let e=0;e<r.files.length;e++)i.fileList.push({index:e,hash:r.files[e].hash,extension:r.files[e].name.split(".").pop(),hasAvif:Boolean(r.files[e].hasavif),hasWebp:Boolean(r.files[e].haswebp),width:r.files[e].width,height:r.files[e].height});n?node_fetch_1.default(getGalleryUrl(i),requestOption).then(function(e){return e.text()}).then(function(e){const a=e.split('content">')[1];void 0!==a&&["artist","group","series","character"].forEach(function(e,t,n){var r;null===(r=a.match(RegExp(`(?<=/${e}/)[a-z0-9%]+(?=-all\\.html)`,"g")))||void 0===r||r.forEach((t,a,n)=>i[`${e}List`].push(decodeURIComponent(t)))}),t(i)}):t(i)})})}}function getGalleryIdList(e,t){if(!isInteger(e.startIndex)||isInteger(e.startIndex)&&e.startIndex<0)throw Error("Invalid startIndex value");if(void 0!==e.endIndex&&(!isInteger(e.endIndex)||isInteger(e.endIndex)&&e.endIndex<=e.startIndex))throw Error("Invalid endIndex value");return new Promise(function(a,n){const r=4*e.startIndex,i=void 0!==e.endIndex?r+4*(e.endIndex+1)-1:"",l=void 0!==t&&void 0!==t.orderBy?t.orderBy:"index",o=void 0!==t&&void 0!==t.reverseResult&&t.reverseResult;node_fetch_1.default(`https://ltn.hitomi.la/${l}-all.nozomi`,Object.assign(Object.assign({},requestOption),{headers:{Range:`bytes=${r}-${i}`}})).then(function(e){return e.arrayBuffer()}).then(function(e){const t=new DataView(e),n=t.byteLength/4;let r=[];if(o)for(let e=0;e<n;e++)r.push(t.getInt32(4*e,!1));else for(let e=n-1;-1!==e;e--)r.push(t.getInt32(4*e,!1));a(r)})})}function parseTag(e){const t=e.split(" ");if(t.length<1)throw Error("Lack of tag");{let e=[...t].map(function(e,t,a){const n=e.replace(/^-/,"").split(":"),[r,i]=[...n];if(2===n.length&&void 0!==r&&void 0!==i&&""!==r&&""!==i&&/^(artist|group|type|language|series|tag|male|female)$/.test(r)&&/^[^-_\.][a-z0-9-_.]+$/.test(i))return`${r}:${i}`;throw Error("Invalid tag")});for(let t=0;t<e.length;t++){const a=e[t];if(e.splice(t,1),-1!==e.indexOf(a))throw Error("Duplicated tag")}let a=[];for(let e=0;e<t.length;e++){const[n,r]=t[e].replace(/^-/,"").split(":");a.push({type:n,name:r,isNegative:t[e].startsWith("-")})}return a}}function queryTag(e){return new Promise(function(t,a){if(e.length<1)throw Error("Lack of tag");{let[a,n]=[[],[]];for(let t=0;t<e.length;t++)switch(void 0!==e[t].isNegative&&e[t].isNegative){case!1:a.push(e[t]);break;case!0:n.push(e[t])}new Promise(function(e,t){return 0===a.length?void getGalleryIdList({startIndex:0}).then(t=>e(t)):void e([])}).then(function(e){return __awaiter(this,void 0,void 0,function*(){let r=e;for(let e=0;e<a.length;e++)yield node_fetch_1.default(getNozomiUrl(a[e]),requestOption).then(function(e){return e.arrayBuffer()}).then(function(t){const a=new DataView(t),n=a.byteLength/4;let i=[];for(let e=0;e<n;e++)i.push(a.getInt32(4*e,!1));let l=new Set(i);r=0!==e?r.filter(function(e,t,a){return l.has(e)?e:void 0}):[...i]});for(let e=0;e<n.length;e++)yield node_fetch_1.default(getNozomiUrl(n[e]),requestOption).then(function(e){return e.arrayBuffer()}).then(function(e){const t=new DataView(e),a=t.byteLength/4;let n=[];for(let e=0;e<a;e++)n.push(t.getInt32(4*e,!1));let i=new Set(n);r=r.filter(function(e,t,a){return i.has(e)?void 0:e})});t(r)})})}})}function getTagList(e,t){return new Promise(function(a,n){if("language"!==e&&"type"!==e&&void 0===t||("language"===e||"type"===e)&&void 0!==t)throw Error("Invalid startingCharacter");"type"===e?a([{type:"type",name:"doujinshi"},{type:"type",name:"manga"},{type:"type",name:"artistcg"},{type:"type",name:"gamecg"},{type:"type",name:"anime"}]):node_fetch_1.default(getTagUrl(e,t),Object.assign({},requestOption)).then(function(e){return e.text()}).then(function(n){let r="";r="language"===e?'(?<=")(?!all)[a-z]+(?=":)':`(?<=/tag/${"male"===e||"female"===e?e+"%3A":""})[a-z0-9%]+(?=-all\\.html)`;const i=n.match(RegExp(r,"g"))||[],l=RegExp(`^(?=[${"123"!==t?t:"0-9"}])[a-z0-9%]+$`);let o=[];for(let t=0;t<i.length;t++){const a=decodeURIComponent(i[t]);("male"!==e&&"female"!==e||i[t].match(l))&&o.push({type:e,name:a})}a(o)})})}function getImageUrl(e,t,a){const n=void 0!==a&&void 0!==a.isThumbnail&&a.isThumbnail;switch(t){case"jpg":if(n||"jpg"===e.extension)break;throw Error("Invalid extension");case"png":if("png"!==e.extension)throw Error("Invalid extension");if(n)throw Error("Invalid extension for thumbnail");break;case"avif":if(e.hasAvif)break;throw Error("Invalid extension");case"webp":if(e.hasWebp){if(n)throw Error("Invalid extension for thumbnail");break}throw Error("Invalid extension")}if(/^[0-9a-f]{64}$/.test(e.hash)){if(!isInteger(e.index)||e.index<0)throw Error("Invalid image index");if(n&&0!==e.index)throw Error("Invalid index for thumbnail");{const a=`${e.hash.slice(-1)}/${e.hash.slice(-3,-1)}/${e.hash}`;let r="",i="";if(n)r="tn",i="jpg"===t||"png"===t?"bigtn":"avifbigtn";else{let a=Number.parseInt(e.hash.slice(-3,-1),16),n=0;a<64?n=2:a<128&&(n=1),r=`${String.fromCharCode(n+97)}`,"jpg"===t||"png"===t?(r+="b",i="images"):(r+="a",i=`${t}`)}return`https://${r}.hitomi.la/${i}/${a}.${t}`}}throw Error("Invalid hash value")}function getGalleryUrl(e){const t=encodeURIComponent(null!==e.title.japanese?e.title.japanese:e.title.display).replace(/\(|\)|'|%(2(0|2|3|5|F)|3(C|E|F)|5(B|D)|7(B|D))/g,"-"),a=null!==e.languageName.local?`-${encodeURIComponent(e.languageName.local)}`:"";return`https://hitomi.la/${e.type}/${t}${a}-${e.id}.html`.toLocaleLowerCase()}function getNozomiUrl(e,t){if("language"!==e.type&&void 0!==t&&(t.orderBy,1))throw Error(`Invalid order criteria for ${e.type} tag type`);{const a=void 0!==t&&void 0!==t.orderBy?t.orderBy:"index";let n="",r="",i="all";switch(e.type){case"male":case"female":n="tag/",r=`${e.type}:${e.name.replace(/_/g," ")}`;break;case"language":r=a,i=e.name;break;default:n=`${e.type}/`,r=e.name.replace(/_/g," ")}return`https://ltn.hitomi.la/n/${n}${r}-${i}.nozomi`}}function getTagUrl(e,t){let a="";switch(e){case"tag":case"male":case"female":a="https://hitomi.la/alltags-";break;case"artist":a="https://hitomi.la/allartists-";break;case"series":a="https://hitomi.la/allseries-";break;case"character":a="https://hitomi.la/allcharacters-";break;case"group":a="https://hitomi.la/allgroups-";break;case"language":a="https://ltn.hitomi.la/language_support.js"}return"language"===e?a:"male"===e?`${a}m.html`:"female"===e?`${a}f.html`:`${a}${t}.html`}function isInteger(e){return!(Number.parseInt(e)!==Number(e)||!Number.isFinite(e)||"object"==typeof e)}exports.getGalleryData=getGalleryData,exports.getGalleryIdList=getGalleryIdList,exports.parseTag=parseTag,exports.queryTag=queryTag,exports.getTagList=getTagList,exports.getImageUrl=getImageUrl,exports.getGalleryUrl=getGalleryUrl,exports.getNozomiUrl=getNozomiUrl,exports.getTagUrl=getTagUrl;class Agent extends https.Agent{createConnection(e,t){return e.servername=void 0,tls.connect(e,t)}}const requestOption={method:"GET",agent:new Agent({rejectUnauthorized:!1,keepAlive:!0}),headers:{Accept:"*/*","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive"}};exports.default={getGalleryData:getGalleryData,getGalleryIdList:getGalleryIdList,parseTag:parseTag,queryTag:queryTag,getTagList:getTagList,getImageUrl:getImageUrl,getGalleryUrl:getGalleryUrl,getNozomiUrl:getNozomiUrl,getTagUrl:getTagUrl};