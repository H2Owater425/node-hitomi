"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))(function(n,i){function l(e){try{s(a.next(e))}catch(e){i(e)}}function o(e){try{s(a.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(l,o)}s((a=a.apply(e,t||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryTag=exports.parseTag=exports.getGalleryIdList=exports.getGalleryData=exports.getNozomiUrl=exports.getGalleryUrl=exports.getImageUrl=void 0;const https_1=__importDefault(require("https")),tls_1=__importDefault(require("tls")),node_fetch_1=__importDefault(require("node-fetch"));Number.isInteger=function(e){return!(Number.parseInt(e)!==Number(e)||!Number.isFinite(e)||"object"==typeof e)};class Agent extends https_1.default.Agent{createConnection(e,t){return e.servername=void 0,tls_1.default.connect(e,t)}}const requestOption={method:"GET",agent:new Agent({rejectUnauthorized:!1,keepAlive:!0}),headers:{Accept:"*/*","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive"}};function getImageUrl(e,t,r){const a=void 0!==r&&r.isThumbnail;switch(t){case"jpg":if(a||"jpg"===e.extension)break;throw Error("Invalid extension");case"png":if("png"!==e.extension)throw Error("Invalid extension");if(a)throw Error("Invalid extension for thumbnail");break;case"avif":if(e.hasAvif)break;throw Error("Invalid extension");case"webp":if(e.hasWebp){if(a)throw Error("Invalid extension for thumbnail");break}throw Error("Invalid extension")}if(!/^[0-9a-f]{64}$/.test(e.hash))throw Error("Invalid hash value");if(!Number.isInteger(e.index)||e.index<0)throw Error("Invalid image index");if(a&&0!==e.index)throw Error("Invalid index for thumbnail");const n=`${e.hash.slice(-1)}/${e.hash.slice(-3,-1)}/${e.hash}`;let i,l;if(a)i="tn",l="jpg"===t||"png"===t?"bigtn":"avifbigtn";else{let r=3,a=Number.parseInt(e.hash.slice(-3,-1),16);a<48&&(r=2),a<9&&(a=1),i=`${String.fromCharCode(a%r+97)}`,"jpg"===t||"png"===t?(i+="b",l="images"):(i+="a",l=`${t}`)}return`https://${i}.hitomi.la/${l}/${n}.${t}`}function getGalleryUrl(e){const t=encodeURIComponent(null!==e.titleJapanese?e.titleJapanese:e.title).replace(/\(|\)|'|%(2(0|2|3|5|F)|3(C|E|F)|5(B|D)|7(B|D))/g,"-"),r=null!==e.languageLocalName?`-${encodeURIComponent(e.languageLocalName)}`:"";return`https://hitomi.la/${e.type}/${t}${r}-${e.id}.html`.toLocaleLowerCase()}function getNozomiUrl(e){let t="",r="",a="all";switch(e.type){case"male":case"female":t="tag/",r=`${e.type}:${e.name.replace(/_/g," ")}`;break;case"language":r="index",a=e.name;break;default:t=`${e.type}/`,r=e.name.replace(/_/g," ")}return`https://ltn.hitomi.la/n/${t}${r}-${a}.nozomi`}function getGalleryData(e,t){if(!Number.isInteger(e)||Number.isInteger(e)&&e<1)throw Error("Invalid id value");const r=void 0===t||t.includeFiles;return new Promise(function(t,a){try{node_fetch_1.default(`https://ltn.hitomi.la/galleries/${e}.js`,requestOption).then(function(e){return e.text()}).then(function(e){const a=JSON.parse(e.slice(18));let n={id:a.id,title:a.title,titleJapanese:a.japanese_title,type:a.type,language:a.language,languageLocalName:a.language_localname,artists:[],groups:[],series:[],characters:[],tags:[],files:null,publishedDate:new Date(`${a.date}:00`.replace(" ","T"))};for(let e=0;e<a.tags.length;e++){let t="tag";Boolean(a.tags[e].male)?t="male":Boolean(a.tags[e].female)&&(t="female"),n.tags.push({name:a.tags[e].tag,type:t})}if(r){n.files=[];for(let e=0;e<a.files.length;e++)n.files.push({index:e,hash:a.files[e].hash,extension:a.files[e].name.split(".").pop(),hasAvif:Boolean(a.files[e].hasavif),hasWebp:Boolean(a.files[e].haswebp),width:a.files[e].width,height:a.files[e].height})}node_fetch_1.default(getGalleryUrl(n),requestOption).then(function(e){return e.text()}).then(function(e){var r,a,i,l;const o=e.split('content">')[1];return void 0===o?void t(n):(null===(r=o.match(/(?<=\/artist\/)[a-z0-9%]+(?=-all\.html)/g))||void 0===r||r.map(function(e,t,r){null===n.artists&&(n.artists=[]),n.artists.push(decodeURIComponent(e))}),null===(a=o.match(/(?<=\/group\/)[a-z0-9%]+(?=-all\.html)/g))||void 0===a||a.map(function(e,t,r){null===n.groups&&(n.groups=[]),n.groups.push(decodeURIComponent(e))}),null===(i=o.match(/(?<=\/series\/)[a-z0-9%]+(?=-all\.html)/g))||void 0===i||i.map(function(e,t,r){null===n.series&&(n.series=[]),n.series.push(decodeURIComponent(e))}),null===(l=o.match(/(?<=\/character\/)[a-z0-9%]+(?=-all\.html)/g))||void 0===l||l.map(function(e,t,r){null===n.characters&&(n.characters=[]),n.characters.push(decodeURIComponent(e))}),void t(n))})})}catch(e){return void a(e)}})}function getGalleryIdList(e,t){if(!Number.isInteger(e.startPage)||Number.isInteger(e.startPage)&&e.startPage<0)throw Error("Invalid startPage value");if(void 0!==e.endPage&&(!Number.isInteger(e.endPage)||Number.isInteger(e.endPage)&&e.endPage<=e.startPage))throw Error("Invalid endPage value");return new Promise(function(r,a){try{const n=4*e.startPage,i=void 0!==e.endPage?n+4*e.endPage-1:"",l=void 0!==t&&t.reverse;node_fetch_1.default("https://ltn.hitomi.la/index-all.nozomi",Object.assign(Object.assign({},requestOption),{headers:{Range:`bytes=${n}-${i}`}})).then(function(e){return e.arrayBuffer()}).then(function(e){const t=new DataView(e),a=t.byteLength/4;let n=[];if(l)for(let e=0;e<a;e++)n.push(t.getInt32(4*e,!1));else for(let e=a-1;-1!==e;e--)n.push(t.getInt32(4*e,!1));r(n)})}catch(e){return void a(e)}})}function parseTag(e){const t=e.split(" ");if(t.length<1)throw Error("Lack of tag");let r=[...t].map(function(e,t,r){const a=e.replace(/^-/,"").split(":"),[n,i]=[...a];if(2!==a.length||void 0===n||void 0===i||""===n||""===i||!/^(artist|group|type|language|series|tag|male|female)$/.test(n)||!/^[^-_\.][a-z0-9-_.]+$/.test(i))throw Error("Invalid tag");return`${n}:${i}`});for(let e=0;e<r.length;e++){const t=r[e];if(r.splice(e,1),-1!==r.indexOf(t))throw Error("Duplicated tag")}let a=[];for(let e=0;e<t.length;e++){const[r,n]=t[e].replace(/^-/,"").split(":");a.push({type:r,name:n,isNegative:t[e].startsWith("-")})}return a}function queryTag(e){if(e.length<1)throw Error("Lack of tag");let t=[],r=[];for(let a=0;a<e.length;a++)switch(void 0!==e[a].isNegative&&e[a].isNegative){case!1:t.push(e[a]);break;case!0:r.push(e[a])}return new Promise(function(e,a){return __awaiter(this,void 0,void 0,function*(){try{let n=[];0===t.length&&(n=yield getGalleryIdList({startPage:0}));for(let e=0;e<t.length;e++)yield node_fetch_1.default(getNozomiUrl(t[e]),requestOption).then(function(e){return e.arrayBuffer()}).then(function(t){const r=new DataView(t),a=r.byteLength/4;let i=[];for(let e=0;e<a;e++)i.push(r.getInt32(4*e,!1));let l=new Set(i);n=0!==e?n.filter(function(e,t,r){return l.has(e)?e:void 0}):[...i]});for(let e=0;e<r.length;e++)yield node_fetch_1.default(getNozomiUrl(r[e]),requestOption).then(function(e){return e.arrayBuffer()}).then(function(e){const t=new DataView(e),r=t.byteLength/4;let a=[];for(let e=0;e<r;e++)a.push(t.getInt32(4*e,!1));let i=new Set(a);n=n.filter(function(e,t,r){return i.has(e)?void 0:e})});return void e(n)}catch(e){return void a(e)}})})}exports.getImageUrl=getImageUrl,exports.getGalleryUrl=getGalleryUrl,exports.getNozomiUrl=getNozomiUrl,exports.getGalleryData=getGalleryData,exports.getGalleryIdList=getGalleryIdList,exports.parseTag=parseTag,exports.queryTag=queryTag,exports.default={getImageUrl:getImageUrl,getGalleryUrl:getGalleryUrl,getNozomiUrl:getNozomiUrl,getGalleryData:getGalleryData,getGalleryIdList:getGalleryIdList,parseTag:parseTag,queryTag:queryTag};