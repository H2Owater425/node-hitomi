"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,a){function o(e){try{s(n.next(e))}catch(e){a(e)}}function l(e){try{s(n.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,l)}s((n=n.apply(e,t||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.requestOption=exports.isInteger=exports.getNozomiUrl=exports.getGalleryUrl=exports.getImageUrl=exports.queryTag=exports.parseTag=exports.getGalleryIdList=exports.getGalleryData=void 0;const node_fetch_1=__importDefault(require("node-fetch")),https_1=__importDefault(require("https")),tls_1=__importDefault(require("tls"));function getGalleryData(e,t){if(!isInteger(e)||isInteger(e)&&e<1)throw Error("Invalid id value");{const r=void 0===t||void 0===t.includeFiles||t.includeFiles,n=void 0===t||void 0===t.includeFullData||t.includeFullData;return new Promise(function(t,i){try{node_fetch_1.default(`https://ltn.hitomi.la/galleries/${e}.js`,exports.requestOption).then(function(e){return e.text()}).then(function(e){const i=JSON.parse(e.slice(18));let a={id:i.id,title:i.title,titleJapanese:i.japanese_title,type:i.type,language:i.language,languageLocalName:i.language_localname,artists:[],groups:[],series:[],characters:[],tags:[],files:null,publishedDate:new Date(`${i.date}:00`.replace(" ","T"))};if(null!==i.tags)for(let e=0;e<i.tags.length;e++){let t="tag";Boolean(i.tags[e].male)?t="male":Boolean(i.tags[e].female)&&(t="female"),a.tags.push({name:i.tags[e].tag,type:t})}if(r){a.files=[];for(let e=0;e<i.files.length;e++)a.files.push({index:e,hash:i.files[e].hash,extension:i.files[e].name.split(".").pop(),hasAvif:Boolean(i.files[e].hasavif),hasWebp:Boolean(i.files[e].haswebp),width:i.files[e].width,height:i.files[e].height})}n?node_fetch_1.default(getGalleryUrl(a),exports.requestOption).then(function(e){return e.text()}).then(function(e){const r=e.split('content">')[1];void 0!==r&&["artist","group","series","character"].forEach(function(e,t,n){var i;null===(i=r.match(RegExp(`(?<=/${e}/)[a-z0-9%]+(?=-all.html)`,"g")))||void 0===i||i.forEach((t,r,n)=>a[e.endsWith("s")?`${e}s`:e].push(decodeURIComponent(t)))}),t(a)}):t(a)})}catch(e){return void i(e)}})}}function getGalleryIdList(e,t){if(!isInteger(e.startIndex)||isInteger(e.startIndex)&&e.startIndex<0)throw Error("Invalid startIndex value");if(void 0!==e.endIndex&&(!isInteger(e.endIndex)||isInteger(e.endIndex)&&e.endIndex<=e.startIndex))throw Error("Invalid endIndex value");return new Promise(function(r,n){try{const i=4*e.startIndex,a=void 0!==e.endIndex?i+4*(e.endIndex+1)-1:"",o=void 0!==t&&void 0!==t.orderCriteria?t.orderCriteria:"index",l=void 0!==t&&void 0!==t.reverse&&t.reverse;node_fetch_1.default(`https://ltn.hitomi.la/${o}-all.nozomi`,Object.assign(Object.assign({},exports.requestOption),{headers:{Range:`bytes=${i}-${a}`}})).then(function(e){return e.arrayBuffer()}).then(function(e){const t=new DataView(e),n=t.byteLength/4;let i=[];if(l)for(let e=0;e<n;e++)i.push(t.getInt32(4*e,!1));else for(let e=n-1;-1!==e;e--)i.push(t.getInt32(4*e,!1));r(i)})}catch(e){return void n(e)}})}function parseTag(e){const t=e.split(" ");if(t.length<1)throw Error("Lack of tag");{let e=[...t].map(function(e,t,r){const n=e.replace(/^-/,"").split(":"),[i,a]=[...n];if(2===n.length&&void 0!==i&&void 0!==a&&""!==i&&""!==a&&/^(artist|group|type|language|series|tag|male|female)$/.test(i)&&/^[^-_\.][a-z0-9-_.]+$/.test(a))return`${i}:${a}`;throw Error("Invalid tag")});for(let t=0;t<e.length;t++){const r=e[t];if(e.splice(t,1),-1!==e.indexOf(r))throw Error("Duplicated tag")}let r=[];for(let e=0;e<t.length;e++){const[n,i]=t[e].replace(/^-/,"").split(":");r.push({type:n,name:i,isNegative:t[e].startsWith("-")})}return r}}function queryTag(e){if(e.length<1)throw Error("Lack of tag");let t=[],r=[];for(let n=0;n<e.length;n++)switch(void 0!==e[n].isNegative&&e[n].isNegative){case!1:t.push(e[n]);break;case!0:r.push(e[n])}return new Promise(function(e,n){new Promise(function(e,r){return 0===t.length?void getGalleryIdList({startIndex:0}).then(t=>e(t)):void e([])}).then(function(n){return __awaiter(this,void 0,void 0,function*(){let i=n;for(let e=0;e<t.length;e++)yield node_fetch_1.default(getNozomiUrl(t[e]),exports.requestOption).then(function(e){return e.arrayBuffer()}).then(function(t){const r=new DataView(t),n=r.byteLength/4;let a=[];for(let e=0;e<n;e++)a.push(r.getInt32(4*e,!1));let o=new Set(a);i=0!==e?i.filter(function(e,t,r){return o.has(e)?e:void 0}):[...a]});for(let e=0;e<r.length;e++)yield node_fetch_1.default(getNozomiUrl(r[e]),exports.requestOption).then(function(e){return e.arrayBuffer()}).then(function(e){const t=new DataView(e),r=t.byteLength/4;let n=[];for(let e=0;e<r;e++)n.push(t.getInt32(4*e,!1));let a=new Set(n);i=i.filter(function(e,t,r){return a.has(e)?void 0:e})});e(i)})})})}function getImageUrl(e,t,r){const n=void 0!==r&&void 0!==r.isThumbnail&&r.isThumbnail;switch(t){case"jpg":if(n||"jpg"===e.extension)break;throw Error("Invalid extension");case"png":if("png"!==e.extension)throw Error("Invalid extension");if(n)throw Error("Invalid extension for thumbnail");break;case"avif":if(e.hasAvif)break;throw Error("Invalid extension");case"webp":if(e.hasWebp){if(n)throw Error("Invalid extension for thumbnail");break}throw Error("Invalid extension")}if(/^[0-9a-f]{64}$/.test(e.hash)){if(!isInteger(e.index)||e.index<0)throw Error("Invalid image index");if(n&&0!==e.index)throw Error("Invalid index for thumbnail");{const r=`${e.hash.slice(-1)}/${e.hash.slice(-3,-1)}/${e.hash}`;let i,a;if(n)i="tn",a="jpg"===t||"png"===t?"bigtn":"avifbigtn";else{let r=3,n=Number.parseInt(e.hash.slice(-3,-1),16);n<48&&(r=2),n<9&&(n=1),i=`${String.fromCharCode(n%r+97)}`,"jpg"===t||"png"===t?(i+="b",a="images"):(i+="a",a=`${t}`)}return`https://${i}.hitomi.la/${a}/${r}.${t}`}}throw Error("Invalid hash value")}function getGalleryUrl(e){const t=encodeURIComponent(null!==e.titleJapanese?e.titleJapanese:e.title).replace(/\(|\)|'|%(2(0|2|3|5|F)|3(C|E|F)|5(B|D)|7(B|D))/g,"-"),r=null!==e.languageLocalName?`-${encodeURIComponent(e.languageLocalName)}`:"";return`https://hitomi.la/${e.type}/${t}${r}-${e.id}.html`.toLocaleLowerCase()}function getNozomiUrl(e,t){if("language"!==e.type&&void 0!==t&&(t.orderCriteria,1))throw Error(`Invalid order criteria for ${e.type} tag type`);{const r=void 0!==t&&void 0!==t.orderCriteria?t.orderCriteria:"index";let n="",i="",a="all";switch(e.type){case"male":case"female":n="tag/",i=`${e.type}:${e.name.replace(/_/g," ")}`;break;case"language":i=r,a=e.name;break;default:n=`${e.type}/`,i=e.name.replace(/_/g," ")}return`https://ltn.hitomi.la/n/${n}${i}-${a}.nozomi`}}function isInteger(e){return!(Number.parseInt(e)!==Number(e)||!Number.isFinite(e)||"object"==typeof e)}exports.getGalleryData=getGalleryData,exports.getGalleryIdList=getGalleryIdList,exports.parseTag=parseTag,exports.queryTag=queryTag,exports.getImageUrl=getImageUrl,exports.getGalleryUrl=getGalleryUrl,exports.getNozomiUrl=getNozomiUrl,exports.isInteger=isInteger;class Agent extends https_1.default.Agent{createConnection(e,t){return e.servername=void 0,tls_1.default.connect(e,t)}}exports.requestOption={method:"GET",agent:new Agent({rejectUnauthorized:!1,keepAlive:!0}),headers:{Accept:"*/*","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive"}};