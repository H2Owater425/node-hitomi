"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const https_1=require("https"),tls_1=require("tls");var hitomi;!function(e){const t=/^(1(0(0[25-7]?|1[0-24-68-9]?|2[09]|3[24-57]|4[1358-9]|5[5-68-9]|6[02]|7[148-9]?|8[1-36-7]|9[0-1468-9])|1(0[13-469]?|1[179]?|2[1-2468-9]|3[046]?|4[1-35]|5[0-15-9]?|6[0468-9]|7[0359]?|8[0-158-9]|9[13])|2(0[135-79]?|1[3-468-9]|2[1-2]?|3[15-9]?|4[36-79]?|5[1-24-579]|6[1468-9]?|7[024-59]|8[0-136-79]|9[02-379]?)|3(0[02-35-68]?|1[0258-9]?|2[357-8]?|3[2-57-9]?|4[2-36-79]|5[1-25-7]|6[13-57-8]?|7[13-469]?|8[0-1579]?|9[0-158])|4(0[1-257-8]|1[14-57-9]?|2[024-79]|3[0-26-9]|4[06-7]?|5[08]?|6[0-24-579]?|7[02-46-9]|8[046-7]|9[1-27])|5(0[02-68]?|1[0-36-7]|2[138-9]|3[2-368-9]|4[0-14-579]|5[0-24-58-9]?|6[2468-9]|7[0-17]|8[2-379]?|9[039]?)?|6(0[1-24-69]|1[0-137]?|2[246-79]|3[0-27]|4[0-14-68]?|5[2-468]?|6[02-38]?|7[26-8]?|8[1-68]|9[18]?)?|7(0[4-9]|1[13-69]|2[0-135-7]?|3[0-136]?|4[135-8]?|5[2-579]?|6[0-258]?|7[03-57]|8[024-79]|9[1-37-8]?)?|8(0[4-68-9]|1[1469]?|2[0-135-68]|3[4-8]?|4[24-57]?|5[137]|6[3-4]|7[0-2579]|8[02-68-9]?|9[0-26-9])?|9(0[3-59]|1[0-2468]?|2[1-246-79]?|3[35-8]|4[0-3579]|5[2-47-8]|6[02-35-69]?|7[025-9]?|8[1-35]?|9[047]?))?|2(0(0[13-46-8]|1[07]?|2[02-36-7]|3[0-258]|4[68]?|5[24-8]|6[02-368-9]?|7[03-468-9]|8[4-68]?|9[1-25-69])|1(0[5-68-9]?|1[35-68-9]|2[0-1469]|3[17-9]?|4[03-47]|5[4-58-9]|6[03-59]|7[1-37-9]?|8[0-579]|9[0-14-68-9])|2(0[0246-9]?|1[1-25]?|2[046-7]|3[24-58-9]?|4[0246-79]?|5[0246]?|6[147-8]|7[02-35-6]|8[1-24-58]|9[1-26-8]?)|3(0[14-5]?|1[0-14]|2[0-13-59]?|3[47-8]|4[1-357-9]|5[0-14-58]?|6[247-9]?|7[0369]?|8[13-47-9]?|9[1-246-79])|4(0[0-26-79]?|1[0-15-6]|2[35]?|3[1-246-9]?|4[13]|5[135-7]?|6[0-157-9]|7[02-48]?|8[04-57-8]?|9[2479]?)|5(0[36-9]|1[17]?|2[03-46-7]|3[1-46-8]|4[158-9]|5[1-38]|6[0-25-7]?|7[5-8]?|8[02-5]|9[246-9]?)|6(0[24-5]?|1[0-26]|2[04-58-9]?|3[04-79]?|4[2-37]?|5[13-79]|6[0-13-57-9]|7[2-479]|8[1-25-8]|9[0-146-79]?)?|7(0[06]?|1[04-68]|2[2-357-9]?|3[02-357-8]?|4[3-57]|5[24-79]|6[1-8]|7[0-158-9]?|8[058-9]?|9[58-9]?)|8(0[036-79]|1[6-7]|2[028]?|3[14]?|4[0-2468]?|5[0-35-69]|6[13-6]?|7[16-8]?|8[147-9]?|9[14])?|9(0[02-358-9]?|1[0-468-9]|2[13-48]?|3[03-79]|4[02-3]|5[0-248-9]|6[02-469]|7[14-57-9]|8[57]?|9[0468]))|3(0(0[14-68]|1[0-14]?|2[3-46]|3[02479]?|4[46-79]|5[1-25-68-9]?|6[24-579]|7[0-246-79]|8[1-246-79]?|9[3-579]?)|1(0[058-9]|1[2-36]|2[1-357-8]?|3[1-37-9]|4[0-13-47-9]|5[0-47-8]?|6[0-379]?|7[1-36]?|8[0-68-9]?|9[06-9])?|2(0[268-9]?|1[0248]|2[48-9]?|3[246-8]|4[02-6]?|5[2-35-68-9]?|6[46-8]|7[2-357]?|8[159]?|9[24-9]?)|3(0[1-258]|1[0-58]?|2[2-579]?|3[0-13-49]?|4[3-57]|5[02-35-79]|6[039]|7[35-69]?|8[0-1469]?|9[13579]?)|4(0[02-579]|1[357]|2[14-57-8]?|3[4-68-9]|4[0-257]?|5[135-9]?|6[68-9]|7[02-49]?|8[0-246-9]?|9[046-7])|5(0[4-57-9]?|1[1-248-9]?|2[1-24-57-9]|3[24-8]|4[0-2479]|5[0-24-68-9]|6[58-9]?|7[1-24-57]?|8[02469]|9[2-36-9])?|6(0[035-9]?|1[037]?|23|3[0368-9]?|4[0-358]?|5[15]|6[49]?|7[6-9]|8[0-35-6]?|9[04-58])?|7(0[0-135-68-9]?|1[135]?|2[1-2]|3[0-135-7]|4[0-168-9]?|5[0-13]?|6[24-57-8]?|7[13-6]?|8[25-79]|9[0-159])|8(0[1-269]?|1[1-38-9]|2[2-35-6]|3[1-35-69]|4[0-25-6]|5[0-135-68-9]|6[0-148-9]|7[0-158]|8[13]?|9[0357-9]?)?|9(0[028]|1[3-9]?|26|3[0-135-68-9]|4[24-8]|5[1-25]?|6[0-136-7]|7[0-15-7]|8[024-68-9]?|9[0-358-9]?)?)|4(0(0[1-259]?|1[1479]|2[5-7]?|3[26-7]?|4[6-9]|5[02-469]|6[138]?|7[5-68-9]?|8[3-49]|9[0-2]?)?|1[0246-8]?|2[2-479]|3[035-69]|4[146-79]|5[0-257-8]|6[0-1358]|7[1-27-9]|8[026-8]|9[13-46-9])?|5(0[14-68-9]?|1[15-6]|2[359]?|3[0-14-5]?|4[369]|5[137-9]|6[13-48]?|7[2-35-79]?|8[27]|9[0-24-58-9]?)|6(0[0-28]?|1[02-35-7]|2[024]?|3[1-2479]|4[2-49]|5[0-35-68]?|6[2-35-79]|7[06-7]|8[138-9]?|9[13-9])?|7(06|1[05-7]|2[24-579]|3[025-7]|4[048]|5[035-68]|6[0379]?|7[5-79]|8[279]?|9[35-68])|8(0[2-36]?|1[2-47-9]|2[1-38-9]?|3[2-38]?|4[03-46]?|5[47-9]?|6[0-15-68-9]|7[02-468]?|8[0-157-9]|9[24-68]?)|9(0[0248-9]|1[0-14-5]?|2[047]|3[0-14-57-8]|4[16]|5[2-46-8]|6[0-135-8]|7[07-9]|8[03-59]|9[14-68]?)?)$/,n=["artist","group","parody","character"];class a extends Error{constructor(e,t){super("Unknown"),this.code=e;const n=t.includes("'")?"`":"'";switch(t=n+t+n,e){case"INVALID_VALUE":this.message="Value of "+t+" was not valid";break;case"DUPLICATED_ELEMENT":this.message="Element of "+t+" was duplicated";break;case"LACK_OF_ELEMENT":this.message="Elements of "+t+" was not enough";break;case"REQEUST_REJECTED":this.message="Request to "+t+" was rejected"}}get name(){return"HitomiError ["+this.code+"]"}}function s(e){return Number.parseInt(e)===Number(e)&&Number.isFinite(e)&&"object"!=typeof e}function i(e,t={}){const n=t.splitBy||4;let a=new ArrayBuffer(e.byteLength),s=new Uint8Array(a);for(let t=0;t<e.byteLength;++t)s[t]=e[t];const i=new DataView(a),r=i.byteLength/n;let l=new Set;for(let e=0;e<r;e++)l.add(i.getInt32(e*n,!1));return l}const r=new class extends https_1.Agent{createConnection(e,t){return(0,tls_1.connect)(Object.assign(e,{servername:void 0}),t)}};function l(e,t={}){return new Promise((function(n,s){const i=new URL(e);(0,https_1.request)({hostname:i.hostname,path:i.pathname,method:"GET",port:443,headers:Object.assign(t,{Accept:"*/*",Connection:"keep-alive",Referer:"https://hitomi.la"}),agent:r},(function(t){let i=[],r=0;switch(t.statusCode){case 200:case 206:t.on("data",(function(e){i.push(e),r+=e.byteLength})).on("error",(function(){s(new a("REQEUST_REJECTED",e))})).on("end",(function(){n(Buffer.concat(i,r))}));break;default:s(new a("REQEUST_REJECTED",e))}})).on("error",(function(){s(new a("REQEUST_REJECTED",e))})).end()}))}function o(e,t={}){if("language"!==e.type||void 0===t.orderBy){let n="",a="",s="all";switch(e.type){case"male":case"female":n="tag/",a=e.type+":"+e.name.replace(/_/g," ");break;case"language":a=t.orderBy||"index",s=e.name;break;default:n=e.type+"/",a=e.name.replace(/_/g," ")}return"https://ltn.hitomi.la/n/"+n+a+"-"+s+".nozomi"}throw new a("INVALID_VALUE","options['orderBy']")}function g(e,t={}){if("language"!==e||void 0===t.startWith){let n="https://hitomi.la/";switch(e){case"tag":case"male":case"female":n+="alltags-";break;case"artist":n+="allartists-";break;case"series":n+="allseries-";break;case"character":n+="allcharacters-";break;case"group":n+="allgroups-";break;case"language":n="ltn."+n+"language_support.js";break;default:throw new a("INVALID_VALUE","extension")}if("language"!==e){switch(e){case"male":n+="m";break;case"female":n+="f";break;default:"0-9"===t.startWith?n+="123":n+=t.startWith}return n+".html"}return n}throw new a("INVALID_VALUE","options['startWith']")}e.getNozomiUrl=o,e.getTagUrl=g,e.getImageUrl=function(e,n,i={}){const r=i.isThumbnail||!1;switch(n){case"jpg":if("jpg"!==e.extension)throw new a("INVALID_VALUE","extension");break;case"png":case"gif":if(r||e.extension!==n)throw new a("INVALID_VALUE","extension");break;case"webp":if(r||!e.hasWebp)throw new a("INVALID_VALUE","extension");break;case"avif":if(e.hasAvif)break;throw new a("INVALID_VALUE","extension");default:throw new a("INVALID_VALUE","extension")}if(/^[0-9a-f]{64}$/.test(e.hash)){if(s(e.index)&&e.index>=0){let a="",s="",i="";if(r)a=e.hash.slice(-1)+"/"+e.hash.slice(-3,-1)+"/"+e.hash,s="tn",i=("avif"===n?"avif":"")+"bigtn";else{const r=String(Number.parseInt(e.hash.slice(-1)+e.hash.slice(-3,-1),16));a="1643882402/"+r+"/"+e.hash,s=t.test(r)?"a":"b","jpg"===n||"png"===n?(s+="b",i="images"):(s+="a",i=n)}return"https://"+s+".hitomi.la/"+i+"/"+a+"."+n}throw new a("INVALID_VALUE","image['index']")}throw new a("INVALID_VALUE","image['hash']")},e.getVideoUrl=function(e){if("anime"===e.type)return"https://streaming.hitomi.la/videos/"+e.title.display.toLowerCase().replace(/\s/g,"-")+".mp4";throw new a("INVALID_VALUE","gallery['type']")},e.getGalleryUrl=function(e){return("https://hitomi.la/"+("artistcg"!==e.type?e.type:"cg")+"/"+encodeURIComponent(Buffer.from(e.title.japanese||e.title.display).slice(0,200).toString("utf-8")).replace(/\(|\)|'|%(2[0235F]|3[CEF]|5[BD]|7[BD])/g,"-")+(null!==e.languageName.local?"-"+encodeURIComponent(e.languageName.local):"")+"-"+e.id+".html").toLocaleLowerCase()},e.getSecondThumbnailIndex=function(e){return Math.ceil((e.files.length-1)/2)},e.getGallery=function(e,t={}){if(s(e)&&e>0)return new Promise((function(a,s){l("https://ltn.hitomi.la/galleries/"+e+".js").then((function(s){var i,r;const l=JSON.parse(s.toString("utf8").slice(18));let o=JSON.parse('{ "id": '+e+', "title": { "display": "'+l.title.replace(/\"/g,'\\"')+'", "japanese": '+(null!==l.japanese_title?'"'+l.japanese_title.replace(/\"/g,'\\"')+'"':"null")+' }, "type": "'+l.type+'", "languageName": { "english": '+(null!==l.language?'"'+l.language+'"':"null")+', "local": '+(null!==l.language_localname?'"'+l.language_localname+'"':"null")+' }, "artists": [], "groups": [], "series": [], "characters": [], "tags": [], "files": [], "publishedDate": null, "translations": [], "relatedIds": [] }');for(let e=0;e<n.length;e++){const t=n[e]+"s";if(null!==l[t])for(let a=0;a<l[t].length;a++)o["parodys"!==t?t:"series"].push(l[t][a][n[e]])}if(null!==l.tags)for(let e=0;e<l.tags.length;e++){let t="tag";Boolean(l.tags[e].male)?t="male":Boolean(l.tags[e].female)&&(t="female"),o.tags.push({type:t,name:l.tags[e].tag})}if(null===(i=t.includeFiles)||void 0===i||i)for(let e=0;e<l.files.length;e++)o.files.push({index:e,hash:l.files[e].hash,extension:l.files[e].name.split(".").pop(),hasAvif:Boolean(l.files[e].hasavif),hasWebp:Boolean(l.files[e].haswebp),width:l.files[e].width,height:l.files[e].height});if(o.publishedDate=new Date(l.date),null!==(r=t.includeRelatedIds)&&void 0!==r&&r){for(let e=0;e<l.languages.length;e++)o.translations.push({id:Number(l.languages[e].galleryid),languageName:{english:l.languages[e].name,local:l.languages[e].language_localname}});o.relatedIds=l.related}a(o)})).catch(s)}));throw new a("INVALID_VALUE","id")},e.getIds=function e(t={}){return new Promise((function(n,r){var g,c,h,u,d,f,p;const[m,w]=[s(null===(g=t.range)||void 0===g?void 0:g.startIndex),s(null===(c=t.range)||void 0===c?void 0:c.endIndex)];!m||(null===(h=t.range)||void 0===h?void 0:h.startIndex)>=0?!w||(null===(u=t.range)||void 0===u?void 0:u.endIndex)>=(null===(d=t.range)||void 0===d?void 0:d.startIndex)?Array.isArray(t.tags)&&0!==t.tags.length?void 0===t.orderBy||"index"===t.orderBy?t.tags.reduce((function(e,t){return e.then((function(e){return new Promise((function(n,a){l(o(t)).then((function(a){const s=t.isNegative||!1,r=i(a);e.forEach((function(t){s===r.has(t)&&e.delete(t)})),n(e)})).catch(a)}))}))}),t.tags[0].isNegative?new Promise((function(t,n){e().then((function(e){t(new Set(e))})).catch(n)})):new Promise((function(e,n){l(o(t.tags.shift())).then((function(t){e(i(t))})).catch(n)}))).then((function(e){var a,s;let i=Array.from(e).slice(null===(a=t.range)||void 0===a?void 0:a.startIndex,null===(s=t.range)||void 0===s?void 0:s.endIndex);t.reverseResult?n(i):n(i.reverse())})).catch(r):r(new a("INVALID_VALUE","options['orderBy']")):l("https://ltn.hitomi.la/"+(t.orderBy||"index")+"-all.nozomi",{Range:"bytes="+(m?4*(null===(f=t.range)||void 0===f?void 0:f.startIndex):"0")+"-"+(w?4*(null===(p=t.range)||void 0===p?void 0:p.endIndex)+3:"")}).then((function(e){let a=Array.from(i(e));t.reverseResult?n(a):n(a.reverse())})).catch(r):r(new a("INVALID_VALUE","options['range']['endIndex']")):r(new a("INVALID_VALUE","options['range']['startIndex']"))}))},e.getParsedTags=function(e){const t=e.split(" ");if(0!==t.length){let e=[],n=new Set;for(let s=0;s<t.length;s++){const i=t[s].replace(/^-/,"").split(":");if(2!==i.length||!/^(artist|group|type|language|series|tag|male|female)$/.test(i[0])||!/^[^-_\.][a-z0-9-_.]+$/.test(i[1]))throw new a("INVALID_VALUE","splitTagStrings["+s+"]");{const r=i[0]+":"+i[1];if(n.has(r))throw new a("DUPLICATED_ELEMENT","splitTagStrings["+s+"]");e.push({type:i[0],name:i[1],isNegative:t[s].startsWith("-")}),n.add(r)}}return e}throw new a("LACK_OF_ELEMENT","splitTagStrings")},e.getTags=function(e,t={}){return new Promise((function(n,s){(void 0===t.startWith?"language"===e||"type"===e:"language"!==e&&"type"!==e)?"type"!==e?l(g(e,{startWith:t.startWith})).then((function(t){const a=t.toString("utf8").match(RegExp("language"===e?'(?<=")(?!all)[a-z]+(?=":)':"(?<=/tag/"+("male"===e||"female"===e?e+"%3A":"")+")[a-z0-9%]+(?=-all\\.html)","g"))||[];let s=[];for(let t=0;t<a.length;t++)s.push({type:e,name:decodeURIComponent(a[t])});n(s)})).catch(s):n([{type:"type",name:"doujinshi"},{type:"type",name:"manga"},{type:"type",name:"artistcg"},{type:"type",name:"gamecg"},{type:"type",name:"anime"}]):s(new a("INVALID_VALUE","options['startWith']"))}))}}(hitomi||(hitomi={})),exports.default=hitomi;